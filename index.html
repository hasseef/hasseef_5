<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>حصيف الوطني — نموذج موحّد (ثلاثي الشعارات)</title>
  <style>
    :root{
      --brand:#5AA044;      /* أخضر حصيف */
      --brand-2:#F8BE43;    /* أصفر حصيف */
      --sa-grey:#7D7E80;    /* رمادي رسمي مكمّل */
      --bg:#0A100F; --card:#0C1513; --muted:#0F1917; --text:#ECF7F2; --dim:#B9C7C1;
      --border:#18231F; --danger:#FF6D6D; --focus:#80FFD1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.65 system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma}
    a{color:var(--brand);text-decoration:none}
    .app{display:grid;grid-template-columns:280px 1fr;gap:16px;padding:16px;max-width:1480px;margin:0 auto}

    /* ===== هيدر رسمي بثلاثة شعارات ===== */
    .app-header{
      grid-column:1/-1; background:linear-gradient(180deg,#0b1412,#0a120f);
      border:1px solid var(--border); border-radius:18px; padding:10px 16px 12px;
      position:relative; overflow:hidden;
    }
    .app-header::after{ /* شريط وطني سفلي */
      content:""; position:absolute; inset:auto 0 0 0; height:4px;
      background:linear-gradient(90deg, var(--brand), var(--brand-2));
      opacity:.9;
    }
    .header-row{display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px}
    .logo-wrap{display:flex; align-items:center; gap:10px; justify-content:flex-start}
    .logo-wrap.center{justify-content:center}
    .logo-wrap.right{justify-content:flex-end}
    .logo-wrap img{display:block; height:48px; width:auto; image-rendering:-webkit-optimize-contrast}
    .brand-title{text-align:center; margin-top:6px; color:var(--dim); font-size:13px; letter-spacing:.2px}

    .header-actions{margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
    .btn{background:#0e1a16;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--brand-2),var(--brand));color:#07140f;font-weight:700}
    .pill{background:#0d1816;border:1px solid var(--border);padding:4px 8px;border-radius:999px;color:var(--dim);font-size:12px}

    .sidebar{align-self:start; position:sticky; top:16px; display:flex; flex-direction:column; gap:12px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 0 0 1px rgba(0,0,0,.08) inset}
    .card-head{padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
    .card-body{padding:12px 14px}
    .nav .group{padding:8px 10px}
    .group-title{color:var(--sa-grey); font-weight:700; font-size:12px; margin:4px 0 8px; letter-spacing:.2px}
    .item{display:block; width:100%; text-align:right; padding:10px 12px; border-radius:10px; border:1px solid transparent; background:transparent; color:var(--text); cursor:pointer}
    .item.active,.item:hover{background:var(--muted); border-color:var(--border)}
    .main{display:flex; flex-direction:column; gap:16px}
    .grid{display:grid; gap:12px} .cols-2{grid-template-columns:repeat(2,1fr)} .cols-3{grid-template-columns:repeat(3,1fr)}
    .kpi{background:var(--muted); border:1px dashed var(--border); border-radius:12px; padding:12px}
    .kpi .num{font-weight:800; font-size:22px} .kpi .lbl{color:var(--dim); font-size:12px}
    .section{display:none} .section.active{display:block}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px 0}
    .mini{color:var(--dim)}
    .list .row + .row{border-top:1px dashed var(--border)}
    .search,input,select,textarea{background:#0d1816;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    table{width:100%} th{color:var(--dim); font-weight:600} td,th{padding:10px; text-align:right}
    .hidden{display:none}

    @media print{
      body{background:#fff; color:#000}
      .app{grid-template-columns:1fr; padding:0}
      .sidebar, .app-header, .btn, .pill{display:none !important}
      .card, .card-head, .card-body{border-color:#000; background:#fff; box-shadow:none}
      .section{display:none !important} #reports.section{display:block !important}
    }
    :focus{outline:2px dashed var(--focus); outline-offset:2px}
    .field{display:flex; flex-direction:column; gap:6px} .hint{font-size:.85rem; color:var(--dim)} .error{font-size:.85rem; color:var(--danger)}
    input.invalid, select.invalid, textarea.invalid{outline:2px solid var(--danger)}
    @media (max-width: 980px){ .app{grid-template-columns:1fr} .sidebar{position:static} .logo-wrap img{height:40px} }
  </style>
</head>
<body>
  <div class="app" role="application">
    <header class="app-header" role="banner" aria-label="ثلاثة شعارات رسمية">
      <div class="header-row">
        <!-- ضع صورك بجوار index.html أو عدّل المسار حسب مجلدك -->
        <div class="logo-wrap right"><img src="talbiya.png" alt="شعار مبادرة تلبية"/></div>
        <div class="logo-wrap center"><img src="hasseef.png" alt="شعار حصيف الوطني"/></div>
        <div class="logo-wrap left"><img src="vision2030.png" alt="شعار رؤية السعودية 2030"/></div>
      </div>
      <div class="brand-title">منصة حصيف الوطني — نموذج واجهة رسمي</div>
      <div class="header-actions" role="toolbar" aria-label="إجراءات">
        <button class="btn" id="langBtn">العربية/English</button>
        <button class="btn" id="themeBtn">النمط</button>
        <button class="btn" id="userBtn">تسجيل الدخول</button>
        <button class="btn primary" id="ctaBtn">جرّب المنصة</button>
      </div>
    </header>

    <aside class="sidebar" role="complementary">
      <nav class="nav card" aria-label="التنقل">
        <div class="group">
          <div class="group-title">الأساس</div>
          <button class="item active" data-route="#/about">عن المنصة</button>
          <button class="item" data-route="#/home">لوحة البداية</button>
          <button class="item" data-route="#/reports">التقارير الذكية</button>
        </div>
        <div class="group">
          <div class="group-title">الحسابات</div>
          <button class="item" data-route="#/acct/indiv">الأفراد</button>
          <button class="item" data-route="#/acct/npo">غير الربحي</button>
          <button class="item" data-route="#/acct/private">القطاع الخاص</button>
          <button class="item" data-route="#/acct/uni">الجامعات</button>
          <button class="item" data-route="#/acct/funder">المانحون</button>
          <button class="item" data-route="#/acct/emirate">الإمارات</button>
        </div>
        <div class="group">
          <div class="group-title">التنفيذ</div>
          <button class="item" data-route="#/events" data-role-min="editor">الفعاليات</button>
          <button class="item" data-route="#/initiatives">المبادرات</button>
          <button class="item" data-route="#/export" data-role-min="editor">تصدير/استيراد</button>
        </div>
      </nav>
      <footer class="mini">© حصيف الوطني — يعمل على GitHub Pages (واجهة فقط)</footer>
    </aside>

    <main id="root" class="main" role="main" tabindex="-1"></main>
  </div>

  <div id="modals"></div>

  <script>
    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
    const ROLE={viewer:0,editor:1,admin:2};

    /* لغة */
    const LANG_KEY='hasseef_lang_v4';
    function setLang(lang){ const L=(lang==='en'?'en':'ar'); localStorage.setItem(LANG_KEY,L); document.documentElement.lang=L; document.documentElement.dir=(L==='en'?'ltr':'rtl'); $('#langBtn').textContent=(L==='en'?'Arabic/English':'العربية/English'); }
    setLang(localStorage.getItem(LANG_KEY)||'ar');

    /* جلسة وأدوار */
    const SESSION_KEY='hasseef_session_v4', STORE_KEY='hasseef_store_v4';
    const sessionGet=()=>{ try{return JSON.parse(localStorage.getItem(SESSION_KEY))||null}catch(_){return null} },
          sessionSet=s=>localStorage.setItem(SESSION_KEY, JSON.stringify(s)),
          sessionClear=()=>localStorage.removeItem(SESSION_KEY);
    function applyRoleVisibility(){
      const s=sessionGet(); const cur=s?ROLE[s.role]||0:0;
      document.querySelectorAll('[data-role-min]').forEach(el=>{
        const need=ROLE[el.getAttribute('data-role-min')]||0; el.style.display=cur>=need?'':'none';
      });
      $('#userBtn').textContent=s?`${s.name} — ${s.role}`:'تسجيل الدخول';
    }

    /* بيانات */
    function seed(){ return {
      regions:[{name:'الرياض',value:30},{name:'مكة',value:22},{name:'الشرقية',value:18},{name:'المدينة',value:10},{name:'عسير',value:8},{name:'القصيم',value:7},{name:'تبوك',value:5}],
      sectors:{التعليم:18,الصحة:14,ريادة:12,سياحة:10,ثقافة:9,إسكان:7,بيئة:6},
      vision:{جودة_الحياة:22,تنمية_القطاع_غير_الربحي:18,التحول_الوطني:16,المدن_الذكية:12},
      opportunitiesMonthly:{volunteer:[3,4,5,6,7,8,9,9,10,11,12,14], training:[2,2,3,3,4,4,5,5,6,6,6,7], jobs:[1,1,2,2,3,3,4,4,5,5,6,6]},
      topDonors:[15,14,13,12,12,11,10,9,8,7],
      initiatives:[
        {id:crypto.randomUUID(), title:'مبادرة تشجير', program:'البيئة', impact:'500 شجرة', ts:Date.now()-86400000*3},
        {id:crypto.randomUUID(), title:'معرض صحي', program:'الصحة', impact:'1000 زائر', ts:Date.now()-86400000*10}
      ]
    }; }
    function load(){ try{return JSON.parse(localStorage.getItem(STORE_KEY))||seed()}catch(_){return seed()} }
    function save(d){ localStorage.setItem(STORE_KEY, JSON.stringify(d)); }
    if(!localStorage.getItem(STORE_KEY)) save(seed());

    /* أدوات */
    const toCSV=rows=>{ if(!rows||!rows.length)return''; const h=Object.keys(rows[0]); const esc=v=>`"${String(v??'').replaceAll('"','""')}"`; return [h.join(',')].concat(rows.map(r=>h.map(k=>esc(r[k])).join(','))).join('\n'); };
    const download=(n,c,m='text/plain;charset=utf-8')=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([c],{type:m})); a.download=n; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1e3); };
    function bars(c,d){ if(!c)return; const x=c.getContext('2d'),w=c.width,h=c.height; x.clearRect(0,0,w,h); const m=Math.max(...d,1),p=24,b=(w-p*2)/d.length-6; d.forEach((v,i)=>{ const X=p+i*(b+6),H=(h-p*2)*v/m; x.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--brand'); x.fillRect(X,h-p-H,b,H); }); x.strokeStyle='#20483f'; x.strokeRect(0,0,w,h); }
    function line(c,d){ if(!c)return; const x=c.getContext('2d'),w=c.width,h=c.height; x.clearRect(0,0,w,h); const m=Math.max(...d,1),p=24,s=(w-p*2)/(d.length-1); x.beginPath(); x.moveTo(p,h-p-(h-p*2)*d[0]/m); d.forEach((v,i)=>x.lineTo(p+i*s,h-p-(h-p*2)*v/m)); x.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--brand-2'); x.lineWidth=2; x.stroke(); x.strokeStyle='#20483f'; x.strokeRect(0,0,w,h); }
    function pie(c,a){ if(!c)return; const x=c.getContext('2d'),w=c.width,h=c.height,r=Math.min(w,h)/2-10; x.clearRect(0,0,w,h); const s=a.reduce((q,b)=>q+(b.value||b),0)||1; let t=-Math.PI/2; a.forEach((it,i)=>{ const f=((it.value||it)/s),e=t+f*Math.PI*2; x.beginPath(); x.moveTo(w/2,h/2); x.arc(w/2,h/2,r,t,e); x.closePath(); x.fillStyle=`hsl(${(i*37)%360} 60% 45%)`; x.fill(); t=e; }); x.strokeStyle='#20483f'; x.strokeRect(0,0,w,h); }

    /* الواجهات */
    const Views={
      about:()=>`<section class="section active"><div class="card"><div class="card-head"><h2 style="margin:0">عن المنصة والرؤية</h2><span class="pill">هوية رسمية</span></div><div class="card-body"><p>ثلاثة شعارات في الرأس: تلبية، حصيف، ورؤية 2030. التصميم يميل للطابع الرسمي مع درجات رمادية مكمّلة.</p><div class="grid cols-3"><div class="kpi"><div class="num">+27</div><div class="lbl">أهداف تفصيلية</div></div><div class="kpi"><div class="num">+96</div><div class="lbl">أهداف فرعية</div></div><div class="kpi"><div class="num">Top 10</div><div class="lbl">جهات داعمة</div></div></div></div></div></section>`,
      home:()=>`<section class="section active"><div class="card"><div class="card-head"><h2 style="margin:0">لوحة البداية</h2><span class="pill">KPIs</span></div><div class="card-body"><div class="grid cols-3"><div class="card"><div class="card-head"><b>تمويل شهري</b></div><div class="card-body"><canvas id="chartFunding" width="380" height="200"></canvas></div></div><div class="card"><div class="card-head"><b>عدد المشاريع</b></div><div class="card-body"><canvas id="chartProjects" width="380" height="200"></canvas></div></div><div class="card"><div class="card-head"><b>توزيع المناطق</b></div><div class="card-body"><canvas id="chartRegions" width="380" height="200"></canvas></div></div></div></div></div></section>`,
      reports:()=>`<section id="reports" class="section active"><div class="card"><div class="card-head"><h2 style="margin:0">التقارير الذكية</h2><span class="pill">Filters & Exports</span></div><div class="card-body">
        <div class="card list" style="margin-bottom:12px"><div class="row" style="flex-wrap:wrap;gap:12px">
          <div style="display:flex; align-items:center; gap:8px"><div class="title">المنطقة</div><select id="filterRegion" class="search"><option value="ALL">الكل</option></select></div>
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap"><div class="title">القطاعات</div><div id="sectorChips" style="display:flex; gap:6px; flex-wrap:wrap"></div></div>
          <div style="margin-inline-start:auto; display:flex; gap:8px"><button class="btn" id="btnApplyFilters">تطبيق</button><button class="btn" id="btnResetFilters">إعادة الضبط</button></div>
        </div></div>
        <div class="grid cols-3">
          <div class="card"><div class="card-head"><b>المناطق</b></div><div class="card-body"><canvas id="repRegions" width="380" height="220"></canvas></div></div>
          <div class="card"><div class="card-head"><b>Top Donors</b></div><div class="card-body"><canvas id="repTopDonors" width="380" height="220"></canvas></div></div>
          <div class="card"><div class="card-head"><b>Vision</b></div><div class="card-body"><canvas id="repVision" width="380" height="220"></canvas></div></div>
        </div>
        <div class="grid cols-2" style="margin-top:12px">
          <div class="card"><div class="card-head"><b>الفرص حسب النوع</b></div><div class="card-body"><canvas id="repOppTypes" width="420" height="220"></canvas></div></div>
          <div class="card"><div class="card-head"><b>المشاريع حسب القطاع</b></div><div class="card-body"><canvas id="repSectors" width="420" height="220"></canvas></div></div>
        </div>
        <div class="row">
          <div class="mini">تصدير:</div>
          <div style="display:flex; gap:8px">
            <button class="btn" id="btnExportCSV">CSV</button>
            <button class="btn" id="btnDownloadJSON">JSON</button>
            <button class="btn" id="btnPrint">PDF</button>
            <button class="btn" id="btnExportPNG">PNG</button>
          </div>
        </div>
      </div></div></section>`,
      initiatives:()=>`<section class="section active"><div class="card"><div class="card-head"><h2 style="margin:0">سجل المبادرات</h2><span class="pill">بحث + تصدير</span></div><div class="card-body">
        <div class="list" style="margin-bottom:12px">
          <div class="row">
            <div><div class="title">بحث</div><div class="desc mini">العنوان/البرنامج/الأثر</div></div>
            <input id="searchInit" class="search" placeholder="اكتب للبحث..." style="max-width:320px"/>
            <div style="display:flex; gap:8px">
              <button class="btn" id="btnNewInit">إضافة</button>
              <button class="btn" id="btnExportInits">تصدير CSV</button>
              <button class="btn" id="btnClearInits">مسح</button>
            </div>
          </div>
        </div>
        <div class="card" style="overflow:auto">
          <table id="initTable" style="border-collapse:separate; border-spacing:0 8px">
            <thead><tr><th>العنوان</th><th>البرنامج</th><th>الأثر</th><th>التاريخ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div></div></section>`,
      events:()=>`<section class="section active" data-role-min="editor"><div class="card"><div class="card-head"><h2 style="margin:0">إدارة الفعاليات</h2><span class="pill">طلبات/موافقات</span></div><div class="card-body">
        <div class="list">
          <div class="row"><div><div class="title">منتدى الإعلام التنموي</div><div class="desc mini">طلبات شراكة: 12</div></div><button class="btn">إدارة</button></div>
          <div class="row"><div><div class="title">معرض تلبية</div><div class="desc mini">شركاء: 8 — الموافقات: 6</div></div><button class="btn">إدارة</button></div>
        </div>
      </div></div></section>`,
      acct:which=>{
        const title={indiv:'حساب الأفراد',npo:'حساب غير الربحي',private:'حساب القطاع الخاص',uni:'حساب الجامعات',funder:'حساب المانحين',emirate:'حساب الإمارات'}[which]||'حساب';
        const action = which==='indiv'?`<div class="row"><button class="btn primary" id="openInitModal">إضافة مبادرة</button></div>`:'';
        return `<section class="section active"><div class="card"><div class="card-head"><h2 style="margin:0">${title}</h2><span class="pill">Demo</span></div><div class="card-body"><div class="mini">قسم ${which}</div>${action}</div></div></section>`;
      },
      export:()=>`<section id="export-tools" class="section active" data-role-min="editor"><div class="card"><div class="card-head"><h2 style="margin:0">تصدير/استيراد</h2></div><div class="card-body list">
        <div class="row"><div><div class="title">تصدير CSV شامل</div><div class="desc mini">مناطق/قطاعات/رؤية/فرص</div></div><button class="btn" id="btnExportCSV">CSV</button></div>
        <div class="row"><div><div class="title">تنزيل JSON</div><div class="desc mini">بيانات LocalStorage</div></div><button class="btn" id="btnDownloadJSON">JSON</button></div>
        <div class="row"><div><div class="title">استيراد JSON</div><div class="desc mini">استبدال البيانات</div></div><div><input type="file" id="jsonFile" accept="application/json" class="hidden"/><button class="btn" id="btnTriggerImport">اختر ملف</button></div></div>
        <div class="row"><div><div class="title">طباعة PDF</div><div class="desc mini">يطبع التقارير</div></div><button class="btn" id="btnPrint">طباعة</button></div>
        <div class="row"><div><div class="title">تصدير تقرير كصورة (PNG)</div><div class="desc mini">يلتقط التقارير</div></div><button class="btn" id="btnExportPNG">PNG</button></div>
      </div></div></section>`
    };

    /* راوتر */
    function mount(h){ const r=document.getElementById('root'); r.innerHTML=h; r.focus(); }
    function render(){ const h=location.hash||'#/about';
      $$('.nav .item').forEach(b=>b.classList.toggle('active', b.getAttribute('data-route')===h));
      const [_,p,s]=h.split('/'); let v='';
      switch(p){ case'about':v=Views.about();break; case'home':v=Views.home();break; case'reports':v=Views.reports();break; case'initiatives':v=Views.initiatives();break; case'events':v=Views.events();break; case'acct':v=Views.acct(s);break; case'export':v=Views.export();break; default:v=Views.about(); }
      mount(v); enhance();
    }

    /* تعزيز */
    function enhance(){
      const S=load();

      /* لوحات */
      if(document.getElementById('chartFunding')){
        bars(document.getElementById('chartFunding'),[5,7,6,8,9,11,10,13,12,15,14,18]);
        line(document.getElementById('chartProjects'),[2,3,4,5,5,6,7,8,9,11,12,14]);
        pie(document.getElementById('chartRegions'),S.regions);
      }

      /* تقارير */
      const reg=document.getElementById('filterRegion'), wrap=document.getElementById('sectorChips');
      if(reg && reg.children.length===1){ S.regions.forEach(r=>{ const o=document.createElement('option'); o.value=r.name; o.textContent=r.name; reg.appendChild(o); }); }
      if(wrap && !wrap.dataset.built){
        Object.keys(S.sectors).forEach(k=>{
          const id='sec_'+k; const lbl=document.createElement('label');
          lbl.className='pill'; lbl.style.cursor='pointer';
          lbl.innerHTML=`<input type="checkbox" id="${id}" style="accent-color: var(--brand)"> ${k}`;
          wrap.appendChild(lbl);
        });
        wrap.dataset.built='1';
      }
      function apply(){
        const F={ region:reg?reg.value:'ALL', sectors:new Set() };
        document.querySelectorAll('#sectorChips input[type="checkbox"]').forEach(ch=>{ if(ch.checked) F.sectors.add(ch.id.replace('sec_','')); });
        const R=JSON.parse(JSON.stringify(S));
        if(F.region!=='ALL') R.regions = R.regions.filter(r=>r.name===F.region);
        if(F.sectors.size>0) Object.keys(R.sectors).forEach(k=>{ if(!F.sectors.has(k)) delete R.sectors[k]; });
        pie(document.getElementById('repRegions'),R.regions);
        bars(document.getElementById('repTopDonors'),S.topDonors);
        bars(document.getElementById('repVision'),Object.values(S.vision));
        const s=S.opportunitiesMonthly;
        bars(document.getElementById('repOppTypes'),[s.volunteer.reduce((a,b)=>a+b,0), s.training.reduce((a,b)=>a+b,0), s.jobs.reduce((a,b)=>a+b,0)]);
        bars(document.getElementById('repSectors'),Object.values(R.sectors));
      }
      document.getElementById('btnApplyFilters')?.addEventListener('click',apply);
      document.getElementById('btnResetFilters')?.addEventListener('click',()=>{ if(reg) reg.value='ALL'; document.querySelectorAll('#sectorChips input[type="checkbox"]').forEach(ch=>ch.checked=false); apply(); });
      if(document.getElementById('repRegions')) apply();

      /* مبادرات */
      const tb=document.querySelector('#initTable tbody');
      if(tb){
        const fmt=ts=>{ const d=new Date(ts); return d.toLocaleDateString('ar-SA',{year:'numeric',month:'short',day:'2-digit'}); };
        const renderRows=()=>{
          const q=(document.getElementById('searchInit')?.value||'').toLowerCase();
          tb.innerHTML='';
          load().initiatives.filter(r=>{
            const t=(r.title||'').toLowerCase(), p=(r.program||'').toLowerCase(), i=(r.impact||'').toLowerCase();
            return [t,p,i].some(x=>x.includes(q));
          }).forEach(r=>{
            const tr=document.createElement('tr');
            tr.style.background='#0c1513';
            tr.innerHTML=`<td>${r.title}</td><td>${r.program||'-'}</td><td>${r.impact||'-'}</td><td>${fmt(r.ts)}</td>`;
            tb.appendChild(tr);
          });
        };
        renderRows();
        document.getElementById('searchInit')?.addEventListener('input',renderRows);
        document.getElementById('btnExportInits')?.addEventListener('click',()=>{
          const rows=load().initiatives.map(r=>({title:r.title,program:r.program,impact:r.impact,date:new Date(r.ts).toISOString()}));
          download('initiatives.csv', toCSV(rows), 'text/csv;charset=utf-8');
        });
        document.getElementById('btnClearInits')?.addEventListener('click',()=>{ if(!confirm('مسح سجل المبادرات؟')) return; const S=load(); S.initiatives=[]; save(S); renderRows(); });
        document.getElementById('btnNewInit')?.addEventListener('click',()=>openInitModal(load(),renderRows));
      }

      /* تصدير/استيراد وطباعة/PNG */
      document.getElementById('btnExportCSV')?.addEventListener('click',()=>{
        const S=load(); const total=a=>a.reduce((x,y)=>x+y,0);
        const rows=[
          ...S.regions.map(r=>({نوع:'منطقة',اسم:r.name,قيمة:r.value})),
          ...Object.entries(S.sectors).map(([k,v])=>({نوع:'قطاع',اسم:k,قيمة:v})),
          ...Object.entries(S.vision).map(([k,v])=>({نوع:'برنامج رؤية',اسم:k,قيمة:v})),
          {نوع:'فرص (سنة)',اسم:'تطوع',قيمة:total(S.opportunitiesMonthly.volunteer)},
          {نوع:'فرص (سنة)',اسم:'تدريب',قيمة:total(S.opportunitiesMonthly.training)},
          {نوع:'فرص (سنة)',اسم:'وظائف',قيمة:total(S.opportunitiesMonthly.jobs)}
        ];
        download('hasseef_summary.csv', toCSV(rows), 'text/csv;charset=utf-8');
      });
      document.getElementById('btnDownloadJSON')?.addEventListener('click',()=> download('hasseef_data.json', JSON.stringify(load(),null,2), 'application/json'));
      document.getElementById('btnTriggerImport')?.addEventListener('click',()=> document.getElementById('jsonFile').click());
      document.getElementById('jsonFile')?.addEventListener('change', e=>{
        const f=e.target.files?.[0]; if(!f) return; const r=new FileReader();
        r.onload=()=>{ try{ const data=JSON.parse(String(r.result||'{}')); save(data); alert('تم الاستيراد'); location.hash='#/reports'; }catch(err){ alert('ملف JSON غير صالح'); } };
        r.readAsText(f);
      });
      document.getElementById('btnPrint')?.addEventListener('click',()=>{ location.hash='#/reports'; setTimeout(()=>window.print(),50); });
      document.getElementById('btnExportPNG')?.addEventListener('click',()=>{
        const node=document.getElementById('root'); const rect=node.getBoundingClientRect();
        const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='${Math.ceil(rect.width)}' height='${Math.ceil(rect.height)}'><foreignObject width='100%' height='100%'>${new XMLSerializer().serializeToString(node)}</foreignObject></svg>`;
        const img=new Image(); const url=URL.createObjectURL(new Blob([svg],{type:'image/svg+xml;charset=utf-8'}));
        img.onload=()=>{ const c=document.createElement('canvas'); c.width=img.width; c.height=img.height; const x=c.getContext('2d'); x.drawImage(img,0,0); URL.revokeObjectURL(url); const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='hasseef_report.png'; a.click(); };
        img.src=url;
      });

      /* أزرار عامة */
      document.getElementById('userBtn')?.addEventListener('click', openAuthModal);
      document.getElementById('langBtn')?.addEventListener('click', ()=> setLang(document.documentElement.lang==='ar'?'en':'ar'));
      document.getElementById('themeBtn')?.addEventListener('click', ()=>{ document.body.style.background = (document.body.style.background ? '' : '#0d1412'); });
      document.getElementById('ctaBtn')?.addEventListener('click', ()=>{ location.hash='#/reports'; });

      applyRoleVisibility();
    }

    function openAuthModal(){
      const s=sessionGet()||{name:'', role:'viewer'};
      const html=`
      <div class="card" role="dialog" aria-modal="true" style="position:fixed; inset:auto 16px 16px 16px; max-width:560px; margin:auto; z-index:99">
        <div class="card-head"><strong>تسجيل الدخول</strong><button class="btn" id="closeAuth">إغلاق</button></div>
        <div class="card-body grid cols-2">
          <div class="field"><label>الاسم</label><input id="authName" class="search" placeholder="الاسم" value="${s.name||''}"/></div>
          <div class="field"><label>الدور</label>
            <select id="authRole" class="search">
              <option value="viewer" ${s.role==='viewer'?'selected':''}>مشاهد</option>
              <option value="editor" ${s.role==='editor'?'selected':''}>محرر</option>
              <option value="admin"  ${s.role==='admin'?'selected':''}>مدير</option>
            </select>
          </div>
          <div style="grid-column:1/-1; display:flex; gap:10px; justify-content:flex-end">
            <button class="btn" id="btnLogin">دخول</button>
            <button class="btn" id="btnLogout">خروج</button>
          </div>
          <div class="hint" style="grid-column:1/-1">الجلسة محلية فقط (LocalStorage).</div>
        </div>
      </div>`;
      const host=document.getElementById('modals'); host.innerHTML=html;
      document.getElementById('closeAuth').onclick=()=> host.innerHTML='';
      document.getElementById('btnLogin').onclick=()=>{ const name=document.getElementById('authName').value.trim()||'Guest'; const role=document.getElementById('authRole').value; sessionSet({name,role}); host.innerHTML=''; applyRoleVisibility(); alert('تم تسجيل الدخول'); };
      document.getElementById('btnLogout').onclick=()=>{ sessionClear(); host.innerHTML=''; applyRoleVisibility(); alert('تم تسجيل الخروج'); };
    }

    function openInitModal(S,onSaved){
      const html=`
      <div class="card" role="dialog" aria-modal="true" style="position:fixed; inset:auto 16px 16px 16px; max-width:720px; margin:auto; z-index:99">
        <div class="card-head"><strong>إضافة مبادرة</strong><button class="btn" id="closeInit">إغلاق</button></div>
        <div class="card-body grid cols-2">
          <div class="field"><label>العنوان *</label><input id="iTitle" class="search" placeholder="عنوان المبادرة"/></div>
          <div class="field"><label>البرنامج *</label><input id="iProgram" class="search" placeholder="برنامج/مسار"/></div>
          <div class="field" style="grid-column:1/-1"><label>الأثر *</label><input id="iImpact" class="search" placeholder="وصف مختصر للأثر"/></div>
          <div class="field" style="grid-column:1/-1"><label>الوصف</label><textarea id="iDesc" class="search" rows="3" placeholder="تفاصيل إضافية (اختياري)"></textarea></div>
          <div style="grid-column:1/-1; display:flex; gap:10px; justify-content:flex-end"><button class="btn primary" id="iSave">حفظ</button></div>
        </div>
      </div>`;
      const host=document.getElementById('modals'); host.innerHTML=html;
      document.getElementById('closeInit').onclick=()=> host.innerHTML='';
      document.getElementById('iSave').onclick=()=>{
        const t=document.getElementById('iTitle'), p=document.getElementById('iProgram'), i=document.getElementById('iImpact');
        [t,p,i].forEach(x=>x.classList.remove('invalid'));
        let ok=true; if(!t.value.trim()){t.classList.add('invalid'); ok=false} if(!p.value.trim()){p.classList.add('invalid'); ok=false} if(!i.value.trim()){i.classList.add('invalid'); ok=false}
        if(!ok) return alert('يرجى تعبئة الحقول الإلزامية');
        S.initiatives.unshift({id:crypto.randomUUID(), title:t.value, program:p.value, impact:i.value, desc:document.getElementById('iDesc').value, ts:Date.now()});
        save(S); host.innerHTML=''; onSaved&&onSaved();
      };
    }

    document.addEventListener('click', e=>{ const b=e.target.closest('[data-route]'); if(b) location.hash=b.getAttribute('data-route'); });
    window.addEventListener('hashchange', render);
    document.addEventListener('DOMContentLoaded', ()=>{ render(); applyRoleVisibility(); });
  </script>
</body>
</html>
