<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>حَصيف — المنصة المتكاملة</title>
<meta name="color-scheme" content="light dark"/>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: { DEFAULT: '#5AA044' },
        accent:  { DEFAULT: '#F8BE43' },
        ink:     { DEFAULT: '#0f172a' },
        stone:   { DEFAULT: '#f8fafc' }
      },
      boxShadow: { soft: '0 10px 20px rgba(2,6,23,.08)' },
      borderRadius: { xl2: '1rem' }
    }
  }
}
</script>
<script src="https://unpkg.com/lucide@latest"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  .scroll-slim::-webkit-scrollbar{width:8px;height:8px}
  .scroll-slim::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:8px}
  .rtl-input{direction:rtl}
  table{border-collapse:separate;border-spacing:0 8px}
  thead th{font-weight:600;color:#0f172a}
  tbody tr{background:#fff;box-shadow:0 1px 2px rgba(2,6,23,.05)}
  tbody td{border-top:1px solid #f1f5f9;border-bottom:1px solid #f1f5f9}
  tbody td:first-child{border-right:1px solid #f1f5f9;border-radius:.5rem 0 0 .5rem}
  tbody td:last-child{border-left:1px solid #f1f5f9;border-radius:0 .5rem .5rem 0}
  #leafletMap{height:360px}
  .tag{padding:.25rem .5rem;border-radius:9999px;font-size:.75rem}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.75rem;background:#e2e8f0;padding:.1rem .35rem;border-radius:.375rem}
  .prose-chat p{margin:.25rem 0}
  .logo-vision,.logo-talbiya,.logo-hasseef{display:block}
  .logo-vision{height:28px}.logo-talbiya{height:36px}.logo-hasseef{height:52px}
  @media (max-width:640px){.logo-vision{height:22px}.logo-talbiya{height:28px}.logo-hasseef{height:42px}}
  @media (min-width:1024px){.logo-vision{height:30px}.logo-talbiya{height:38px}.logo-hasseef{height:58px}}
</style>
</head>
<body class="bg-stone text-ink antialiased">

<!-- Header -->
<header class="sticky top-0 z-40 shadow-soft bg-slate-900 text-white">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-wrap items-center gap-3">
    <!-- Right: Hasseef -->
    <div class="flex items-center gap-2 order-1 md:order-1">
      <!-- Base64 placeholder — استبدله لاحقًا بالشعار الحقيقي -->
      <img class="logo-hasseef object-contain" alt="حصيف"
        src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAeCAYAAAC0y1ySAAAACXBIWXMAAAsSAAALEgHS3X78AAABWUlEQVR4nO2XwQ3CMAxFvQw0Y3B8VQpCwDk+0nN4X3p0wF2c0mC0I3b2x2R7b2Qq2pXl3q3k9I3q7E0kQvB0wqjVd0v1vU7QwHf7m7n0KcJqv6b0v8y3o4gqQq0pKQm9nQnq8w1hL3g3l9Q8E3qF7t3m9iU1vF3bVg2E9lJ6zv1yE0U8mJm2yG7G3bCqgQ5Wm7C3b7gZyZk8F5q2w4W5q0QO0qQo6mCwY6Q0Qk6Q0gI2f8hC5FQ8t0tQw+eHq9yQrx7mZLkFJz8q9p0aL3g5bH5O3z0uYkXwG3u2m9CwQy4C1n9s6wq0b3kWm7b8J6mUq9p2p6r4y7kqg2wQm8T1k2b9q4wTQeU1M2vE6R8o7kqg2wQk+5uQf9Z4f8d7xT9mG0c0h8b3f7mG3VQn+X2c1pR3UAg0RJWorZr2xQZg1aW+H2o3wR2mXg8DgZ6QAAAABJRU5ErkJggg==" />
      <div class="leading-5">
        <div class="font-semibold">حَصيف</div>
        <div class="text-xs text-slate-200">منصة تكامل تنموي لتسريع تحقيق مستهدفات رؤية 2030</div>
      </div>
    </div>

    <div class="flex-1 order-2"></div>

    <!-- Center tools -->
    <div class="order-3 flex items-center gap-3 w-full max-w-3xl">
      <div class="flex items-center gap-2">
        <button id="btnAR" class="px-2 py-1 rounded-lg bg-white/10 text-white text-xs hover:bg-white/20">عربي</button>
        <button id="btnEN" class="px-2 py-1 rounded-lg bg-white/10 text-white text-xs hover:bg-white/20">English</button>
      </div>
      <div class="relative flex-1">
        <input id="globalSearch" type="search"
          class="rtl-input w-full rounded-xl2 border border-white/20 bg-white/10 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-primary/40 px-4 py-2 text-sm"
          placeholder="ابحث عن: مشروع، فعالية، وظيفة، منحة، مرفق..."/>
        <button class="absolute left-2 top-1/2 -translate-y-1/2 text-white" aria-label="Search">
          <i data-lucide="search" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="flex items-center gap-2 text-xs">
        <span class="text-slate-200">الدور:</span>
        <select id="roleSelect" class="rtl-input border border-white/20 bg-white/10 text-white rounded-lg px-2 py-1 text-xs">
          <option value="viewer">Viewer</option>
          <option value="editor">Editor</option>
          <option value="manager">Manager</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <button id="btnNotifications" class="relative p-2 rounded-xl2 hover:bg-white/10 transition text-white" aria-label="Notifications">
        <i data-lucide="bell" class="w-5 h-5"></i>
        <span class="absolute -top-1 -right-1 bg-primary text-white text-[10px] leading-4 rounded-full px-1.5">3</span>
      </button>
    </div>

    <!-- Left: Vision 2030 + Talbiya (Base64 placeholders) -->
    <div class="order-4 flex items-center gap-3">
      <img class="logo-vision object-contain" alt="Vision 2030"
        src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACHqG7QAAAACXBIWXMAAAsSAAALEgHS3X78AAAAs0lEQVR4nO3ZsQnCMBQF0T0cKcQ0o7mGv3AQp1l1p8gQ4wc8C0r0k1m3m2T5w8W6qv9iQYk1r4m8mQf0rU8cC2fE2b44vWgQGJ3oXo7B1h3e3gqF8gE0m9M2oGg8il8xk3r9dXo0o9n7H0u3sS8f3v5vQASw4g4tJ0g0fQbW2yKcJw7o7lJ3Gx3bQGx3XQmWk9i7JkQ9a4w5k9o9z1Q3Ew6gY7H8QdJ8B1Y6mJm2d9Rk9p4rT2IhH1p2PG0qgV7b3N8w2VbVt1Q=="/>
      <img class="logo-talbiya object-contain" alt="مبادرة تلبية"
        src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACHqG7QAAAACXBIWXMAAAsSAAALEgHS3X78AAAAtUlEQVR4nO3ZsQnCMBQF0b0cKdT0YbnGv3AQp1l1p8gQ4wc8C0p0k1m3m2T5w8W6qv9iQYk1r4m8mQf0rU8cC2fE2b44vWgQGJ3oXo7B1h3e3gqF8gE0m9M2oGg8il8xk3r9dXo0o9n7H0u3sS8f3v5vQASw4g4tJ0g0fQbW2yKcJw7o7lJ3Gx3bQGx3XQmWk9i7JkQ9a4w5k9o9z1Q3Ew6gY7H8QdJ8B1Y6mJm2d9Rk9p4rT2IhH1p2PG0qgV7b3N8w2VbVt1Q=="/>
    </div>
  </div>
</header>

<!-- Layout -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-12 gap-6">
  <!-- Sidebar -->
  <aside class="col-span-12 md:col-span-3 lg:col-span-3">
    <div class="bg-white rounded-2xl shadow-soft p-4 space-y-4">
      <div>
        <div class="text-xs font-semibold text-slate-500 mb-2">القسم العام</div>
        <nav class="space-y-1" id="navMain">
          <button data-route="dashboard" class="navlink w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50">
            <span class="flex items-center gap-2"><i data-lucide="layout-dashboard" class="w-4 h-4"></i><span>الرئيسية</span></span>
            <span class="text-xs text-slate-400"><span class="kbd">Alt</span>+<span class="kbd">1</span></span>
          </button>
          <button data-route="map" class="navlink w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50">
            <span class="flex items-center gap-2"><i data-lucide="map" class="w-4 h-4"></i><span>خريطة المشاريع</span></span>
          </button>
          <button data-route="stories" class="navlink w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50">
            <span class="flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i><span>قصص الأثر</span></span>
          </button>
          <button data-route="reports" class="navlink w-full flex items-center justify_between px-3 py-2 rounded-lg hover:bg-slate-50">
            <span class="flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4"></i><span>التقارير</span></span>
          </button>
          <button data-route="ai" class="navlink w-full flex items-center justify_between px-3 py-2 rounded-lg hover:bg-slate-50">
            <span class="flex items-center gap-2"><i data-lucide="bot" class="w-4 h-4"></i><span>مختبر الذكاء الاصطناعي</span></span>
          </button>
          <button data-route="integrations" class="navlink w-full flex items-center justify_between px-3 py-2 rounded-lg hover:bg-slate-50">
            <span class="flex items-center gap-2"><i data-lucide="plug" class="w-4 h-4"></i><span>التكاملات</span></span>
          </button>
          <button data-route="admin-center" class="navlink w-full flex items-center justify_between px-3 py-2 rounded-lg hover:bg-slate-50">
            <span class="flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i><span>مركز الإدارة</span></span>
          </button>
        </nav>
      </div>

      <div class="pt-2">
        <div class="text-xs font-semibold text-slate-500 mb-2">الحسابات</div>
        <div class="grid grid-cols-2 gap-2" id="accountsGrid"></div>
      </div>

      <div class="pt-2">
        <div class="text-xs font-semibold text-slate-500 mb-2">المكوّنات</div>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2" id="modulesGrid"></div>
      </div>
    </div>

    <div class="mt-4 bg-white rounded-2xl shadow-soft p-4">
      <div class="text-xs font-semibold text-slate-500 mb-2">إجراءات سريعة</div>
      <div class="grid grid-cols-2 gap-2">
        <button id="btnNewProject" class="px-3 py-2 rounded-lg text-sm bg-primary text-white hover:opacity-95">+ مشروع</button>
        <button id="btnNewEvent" class="px-3 py-2 rounded-lg text-sm bg-slate-900 text-white hover:opacity-90">+ فعالية</button>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="col-span-12 md:col-span-9 lg:col-span-9 space-y-6">
    <!-- Dashboard -->
    <section id="dashboard" class="view">
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
        <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500">المشاريع النشطة</div><div id="kpiProjects" class="text-2xl font-bold mt-1">—</div></div>
        <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500">قيمة التمويل (ر.س)</div><div id="kpiFunding" class="text-2xl font-bold mt-1">—</div></div>
        <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500">الفعاليات القادمة</div><div id="kpiEvents" class="text-2xl font-bold mt-1">—</div></div>
        <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500">فرص التطوع</div><div id="kpiVol" class="text-2xl font-bold mt-1">—</div></div>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow-soft mt-4">
        <div class="flex flex-wrap items-center gap-2">
          <select id="filterRegion" class="rtl-input border rounded-lg px-3 py-2 text-sm">
            <option value="">كل المناطق</option>
            <option>حائل</option><option>الرياض</option><option>مكة المكرمة</option>
          </select>
          <select id="filterSector" class="rtl-input border rounded-lg px-3 py-2 text-sm">
            <option value="">كل القطاعات</option>
            <option>حكومي</option><option>خاص</option><option>غير ربحي</option><option>جامعات</option>
          </select>
          <select id="filterProgram" class="rtl-input border rounded-lg px-3 py-2 text-sm">
            <option value="">برامج الرؤية</option>
            <option>التحول الوطني</option><option>جودة الحياة</option><option>تنمية القدرات البشرية</option>
            <option>تطوير القطاع المالي</option><option>الصناعة الوطنية والخدمات اللوجستية</option><option>الإسكان</option>
          </select>
          <div class="flex-1"></div>
          <button id="btnExportPDF" class="text-sm px-3 py-2 rounded-lg bg-slate-900 text-white">تصدير PDF</button>
          <button id="btnExportXLSX" class="text-sm px-3 py-2 rounded-lg bg-slate-100">تصدير Excel</button>
          <button id="btnResetFilters" class="text-sm px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">إعادة الضبط</button>
        </div>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow-soft mt-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">المشاريع</div>
          <div class="text-xs text-slate-500">نموذج عرض — للتجربة</div>
        </div>
        <div class="overflow-auto scroll-slim">
          <table class="w-full text-sm" id="projectsTable">
            <thead>
              <tr class="text-right text-slate-500">
                <th class="px-3 py-2">المشروع</th><th class="px-3 py-2">القطاع</th><th class="px-3 py-2">المنطقة</th>
                <th class="px-3 py-2">البرنامج</th><th class="px-3 py-2">التمويل (ر.س)</th><th class="px-3 py-2">الحالة</th><th class="px-3 py-2"></th>
              </tr>
            </thead>
            <tbody id="projectsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Map -->
    <section id="map" class="view hidden">
      <div class="bg-white rounded-2xl p-6 shadow-soft">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">خريطة المشاريع</h2>
          <div class="text-xs text-slate-500">© <a href="https://www.openstreetmap.org/copyright" target="_blank" class="underline">OpenStreetMap</a>, © Leaflet</div>
        </div>
        <div id="leafletMap" class="mt-4 rounded-xl2"></div>
        <div class="mt-3 text-xs text-slate-500">الخريطة تجريبية وتعرض مؤشرات عدد المشاريع لكل منطقة.</div>
      </div>
    </section>

    <!-- Stories -->
    <section id="stories" class="view hidden">
      <div class="bg-white rounded-2xl p-6 shadow-soft">
        <h2 class="text-lg font-semibold mb-3">قصص أثر مختارة</h2>
        <div id="storiesWrap" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </section>

    <!-- Reports -->
    <section id="reports" class="view hidden">
      <div class="bg-white rounded-2xl p-6 shadow-soft">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">التقارير والتحليلات</h2>
          <div class="flex items-center gap-2">
            <input type="file" id="csvUpload" accept=".csv" class="hidden"/>
            <label for="csvUpload" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm cursor-pointer">تحميل CSV</label>
            <button id="btnExportRptPDF" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">تصدير PDF</button>
            <button id="btnExportRptXLSX" class="px-3 py-2 rounded-lg bg-slate-100 text-sm">تصدير Excel</button>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">عدد المشاريع</div><div id="repProjects" class="text-2xl font-bold">—</div></div>
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">إجمالي التمويل</div><div id="repFunding" class="text-2xl font-bold">—</div></div>
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">الفعاليات المقبلة</div><div id="repEvents" class="text-2xl font-bold">—</div></div>
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">فرص التطوع</div><div id="repVol" class="text-2xl font-bold">—</div></div>
        </div>

        <div class="mt-4 overflow-auto scroll-slim">
          <table class="w-full text-sm" id="reportsTable">
            <thead>
              <tr class="text-right text-slate-500">
                <th class="px-3 py-2">#</th><th class="px-3 py-2">المشروع</th><th class="px-3 py-2">القطاع</th><th class="px-3 py-2">المنطقة</th><th class="px-3 py-2">التمويل</th><th class="px-3 py-2">الحالة</th>
              </tr>
            </thead>
            <tbody id="reportsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- AI Lab -->
    <section id="ai" class="view hidden">
      <div class="bg-white rounded-2xl p-6 shadow-soft">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">مختبر الذكاء الاصطناعي</h2>
          <div class="text-xs text-slate-500">وضع تجريبي — دون اتصال بخادم خارجي</div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="md:col-span-2 border rounded-2xl p-4 flex flex-col gap-3">
            <div id="aiFeed" class="prose-chat max-h-[420px] overflow-auto scroll-slim"></div>
            <div class="flex items-center gap-2">
              <input id="aiInput" class="rtl-input flex-1 border rounded-lg px-3 py-2" placeholder="اكتب سؤالك..."/>
              <button id="aiSend" class="px-3 py-2 rounded-lg bg-slate-900 text-white"><i data-lucide="send" class="w-4 h-4"></i></button>
            </div>
          </div>
          <div class="border rounded-2xl p-4 space-y-3">
            <div class="font-semibold">قوالب سريعة</div>
            <button class="w-full px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm" data-ai-template="اقترح مؤشرات أداء لمبادرة تمكين">مؤشرات أداء</button>
            <button class="w-full px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm" data-ai-template="صيّغ إعلان لفعالية تطوعية في حائل">نص إعلان</button>
            <button class="w-full px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm" data-ai-template="صمّم هيكل تقرير مختصر لمشاريع الجامعات">هيكل تقرير</button>
            <div class="text-xs text-slate-500">يمكن ربطه لاحقًا بـ API فعلي.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Integrations -->
    <section id="integrations" class="view hidden">
      <div class="bg-white rounded-2xl p-6 shadow-soft">
        <h2 class="text-lg font-semibold mb-2">التكاملات</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="border rounded-2xl p-4">
            <div class="flex items-center justify-between">
              <div class="font-semibold">مفاتيح API</div>
              <button id="btnGenKey" class="px-3 py-2 rounded-lg bg-primary text-white text-sm">توليد مفتاح</button>
            </div>
            <div id="keysWrap" class="mt-3 space-y-2 text-sm"></div>
          </div>
          <div class="border rounded-2xl p-4">
            <div class="font-semibold">Webhooks</div>
            <form id="hookForm" class="mt-2 flex items-center gap-2">
              <input name="url" class="rtl-input flex-1 border rounded-lg px-3 py-2" placeholder="https://example.com/hook"/>
              <button class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">إضافة</button>
            </form>
            <div id="hooksWrap" class="mt-3 space-y-2 text-sm"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Admin Center -->
    <section id="admin-center" class="view hidden">
      <div class="bg-white rounded-2xl p-6 shadow-soft space-y-6">
        <div>
          <h3 class="text-lg font-semibold">إعدادات SSO</h3>
          <form id="ssoForm" class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
            <input name="issuer" class="rtl-input border rounded-lg px-3 py-2" placeholder="Issuer (OIDC/SAML)"/>
            <input name="client_id" class="rtl-input border rounded-lg px-3 py-2" placeholder="Client ID"/>
            <input name="client_secret" class="rtl-input border rounded-lg px-3 py-2" placeholder="Client Secret"/>
            <input name="redirect" class="rtl-input border rounded-lg px-3 py-2 md:col-span-3" placeholder="Redirect URL"/>
            <div class="md:col-span-3"><button class="px-3 py-2 rounded-lg bg-primary text-white text-sm">حفظ</button></div>
          </form>
        </div>

        <div>
          <h3 class="text-lg font-semibold">صلاحيات المستخدمين</h3>
          <div class="overflow-auto scroll-slim border rounded-2xl p-3">
            <table class="w-full text-sm">
              <thead><tr class="text-right text-slate-500">
                <th class="px-3 py-2">المستخدم</th><th class="px-3 py-2">الدور</th><th class="px-3 py-2">عمليات</th>
              </tr></thead>
              <tbody id="usersTbody"></tbody>
            </table>
          </div>
          <form id="userAddForm" class="mt-3 flex items-center gap-2">
            <input name="name" class="rtl-input border rounded-lg px-3 py-2" placeholder="اسم المستخدم"/>
            <select name="role" class="rtl-input border rounded-lg px-2 py-2">
              <option value="viewer">Viewer</option>
              <option value="editor">Editor</option>
              <option value="manager">Manager</option>
              <option value="admin">Admin</option>
            </select>
            <button class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">إضافة</button>
          </form>

          <div class="mt-4">
            <div class="text-sm font-semibold mb-2">مصفوفة الأذونات</div>
            <div class="overflow-auto scroll-slim">
              <table class="w-full text-sm">
                <thead><tr class="text-right text-slate-500">
                  <th class="px-3 py-2">الإجراء</th><th class="px-3 py-2">Viewer</th><th class="px-3 py-2">Editor</th><th class="px-3 py-2">Manager</th><th class="px-3 py-2">Admin</th>
                </tr></thead>
                <tbody>
                  <tr><td class="px-3 py-2">إنشاء مشروع</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✔️</td><td class="px-3 py-2">✔️</td><td class="px-3 py-2">✔️</td></tr>
                  <tr><td class="px-3 py-2">اعتماد فعالية</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✔️</td><td class="px-3 py-2">✔️</td></tr>
                  <tr><td class="px-3 py-2">إدارة المستخدمين</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✔️</td></tr>
                  <tr><td class="px-3 py-2">إنشاء منحة</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✔️</td><td class="px-3 py-2">✔️</td><td class="px-3 py-2">✔️</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Account: Private (FULL) -->
    <section id="account-private" class="view hidden">
      <div class="bg-white rounded-2xl p-6 shadow-soft space-y-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-sm text-slate-500">حساب</div>
            <h2 class="text-xl font-bold">القطاع الخاص</h2>
            <div class="mt-1 flex flex-wrap items-center gap-2">
              <span class="tag bg-slate-100 text-slate-700">منشآت</span>
              <span class="tag bg-emerald-100 text-emerald-700">نشط</span>
              <span class="tag bg-amber-100 text-amber-700">أولوية برامج الرؤية</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnPrivateNewProject" class="px-3 py-2 rounded-lg bg-primary text-white text-sm">+ مشروع جديد</button>
            <button id="btnPrivateExport" class="px-3 py-2 rounded-lg bg-slate-100 text-sm">تصدير</button>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">مشاريعي</div><div id="pvtKpiProjects" class="text-2xl font-bold">—</div></div>
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">إجمالي التمويل</div><div id="pvtKpiFunding" class="text-2xl font-bold">—</div></div>
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">شراكات موقعة</div><div id="pvtKpiPartners" class="text-2xl font-bold">—</div></div>
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">طلبات قيد المعالجة</div><div id="pvtKpiPending" class="text-2xl font-bold">—</div></div>
        </div>

        <div class="border-b flex items-center gap-2 text-sm">
          <button class="pvtTab px-3 py-2 rounded-t-lg bg-slate-900 text-white" data-tab="pvt-overview">نظرة عامة</button>
          <button class="pvtTab px-3 py-2 hover:bg-slate-100" data-tab="pvt-projects">مشاريعي</button>
          <button class="pvtTab px-3 py-2 hover:bg-slate-100" data-tab="pvt-partnerships">شراكات</button>
          <button class="pvtTab px-3 py-2 hover:bg-slate-100" data-tab="pvt-requests">طلبات/وثائق</button>
        </div>

        <div id="pvt-overview" class="pvtTabView">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
            <div class="lg:col-span-2 bg-white rounded-xl border p-4">
              <div class="font-semibold mb-2">ملخص الحساب</div>
              <p class="text-sm text-slate-600">هذا الحساب مخصص لشركات ومنشآت القطاع الخاص ويركّز على المشاريع ذات الأثر التنموي المتوافق مع برامج الرؤية.</p>
              <ul class="list-disc pr-5 mt-3 text-sm text-slate-600">
                <li>أولوية التقييم للمشاريع ذات الشراكات المتعددة.</li>
                <li>قنوات تمويل مشتركة مع المانحين والقطاع غير الربحي.</li>
                <li>اشتراطات الامتثال والتوثيق قبل الإطلاق.</li>
              </ul>
            </div>
            <div class="bg-white rounded-xl border p-4">
              <div class="font-semibold mb-2">شركاء مقترحون</div>
              <div id="pvtPartners" class="space-y-2 text-sm"></div>
            </div>
          </div>
        </div>

        <div id="pvt-projects" class="pvtTabView hidden">
          <div class="mt-4 overflow-auto scroll-slim">
            <table class="w-full text-sm" id="pvtProjectsTable">
              <thead>
                <tr class="text-right text-slate-500">
                  <th class="px-3 py-2">المشروع</th><th class="px-3 py-2">المنطقة</th><th class="px-3 py-2">البرنامج</th><th class="px-3 py-2">التمويل</th><th class="px-3 py-2">الحالة</th><th class="px-3 py-2"></th>
                </tr>
              </thead>
              <tbody id="pvtProjectsTbody"></tbody>
            </table>
          </div>
        </div>

        <div id="pvt-partnerships" class="pvtTabView hidden">
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3" id="pvtPartnershipsGrid"></div>
        </div>

        <div id="pvt-requests" class="pvtTabView hidden">
          <div class="mt-4">
            <form id="pvtReqForm" class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <input name="title" class="rtl-input border rounded-lg px-3 py-2" placeholder="عنوان الطلب/الوثيقة" required>
              <select name="type" class="rtl-input border rounded-lg px-3 py-2"><option>خطاب نوايا</option><option>خطة عمل</option><option>ميزانية</option><option>اتفاقية</option></select>
              <button class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">إضافة</button>
            </form>
            <div id="pvtReqList" class="mt-3 space-y-2 text-sm"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Account: Funder (FULL) -->
    <section id="account-funder" class="view hidden">
      <div class="bg-white rounded-2xl p-6 shadow-soft space-y-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-sm text-slate-500">حساب</div>
            <h2 class="text-xl font-bold">الجهة المانحة</h2>
            <div class="mt-1 flex flex-wrap items-center gap-2">
              <span class="tag bg-slate-100 text-slate-700">تمويل</span>
              <span class="tag bg-emerald-100 text-emerald-700">نشط</span>
              <span class="tag bg-amber-100 text-amber-700">دعوات مفتوحة</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnFndNewCall" class="px-3 py-2 rounded-lg bg-primary text-white text-sm">+ دعوة تمويل</button>
            <button id="btnFndExport" class="px-3 py-2 rounded-lg bg-slate-100 text-sm">تصدير</button>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">المنح النشطة</div><div id="fndKpiActiveGrants" class="text-2xl font-bold">—</div></div>
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">المبالغ الملتزم بها</div><div id="fndKpiPledged" class="text-2xl font-bold">—</div></div>
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">المبالغ المصروفة</div><div id="fndKpiDisbursed" class="text-2xl font-bold">—</div></div>
          <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">طلبات قيد المراجعة</div><div id="fndKpiPending" class="text-2xl font-bold">—</div></div>
        </div>

        <div class="border-b flex items-center gap-2 text-sm">
          <button class="fndTab px-3 py-2 rounded-t-lg bg-slate-900 text-white" data-tab="fnd-overview">نظرة عامة</button>
          <button class="fndTab px-3 py-2 hover:bg-slate-100" data-tab="fnd-calls">دعوات مفتوحة</button>
          <button class="fndTab px-3 py-2 hover:bg-slate-100" data-tab="fnd-apps">طلبات التمويل</button>
          <button class="fndTab px-3 py-2 hover:bg-slate-100" data-tab="fnd-disb">الصرف والمتابعة</button>
          <button class="fndTab px-3 py-2 hover:bg-slate-100" data-tab="fnd-partners">شركاء</button>
        </div>

        <div id="fnd-overview" class="fndTabView">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
            <div class="lg:col-span-2 bg-white rounded-xl border p-4">
              <div class="font-semibold mb-2">سياسة التمويل</div>
              <ul class="list-disc pr-5 mt-2 text-sm text-slate-600">
                <li>أولوية للمشاريع المتوافقة مع برامج الرؤية.</li>
                <li>اشتراط أثر قابل للقياس (KPIs) وخطة استدامة.</li>
                <li>صرف على دفعات وفق مؤشرات الإنجاز.</li>
              </ul>
            </div>
            <div class="bg-white rounded-xl border p-4">
              <div class="font-semibold mb-2">مستندات مطلوبة</div>
              <ul class="list-disc pr-5 mt-2 text-sm text-slate-600">
                <li>خطة عمل مختصرة</li><li>ميزانية تفصيلية</li><li>حوكمة ومخاطر</li>
              </ul>
            </div>
          </div>
        </div>

        <div id="fnd-calls" class="fndTabView hidden">
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3" id="fndCallsGrid"></div>
        </div>

        <div id="fnd-apps" class="fndTabView hidden">
          <div class="mt-4 overflow-auto scroll-slim">
            <table class="w-full text-sm" id="fndAppsTable">
              <thead><tr class="text-right text-slate-500">
                <th class="px-3 py-2">الجهة المتقدمة</th><th class="px-3 py-2">العنوان</th><th class="px-3 py-2">المبلغ</th><th class="px-3 py-2">الحالة</th><th class="px-3 py-2"></th>
              </tr></thead>
              <tbody id="fndAppsTbody"></tbody>
            </table>
          </div>
        </div>

        <div id="fnd-disb" class="fndTabView hidden">
          <div class="mt-4 overflow-auto scroll-slim">
            <table class="w-full text-sm" id="fndDisbTable">
              <thead><tr class="text-right text-slate-500">
                <th class="px-3 py-2">المنحة</th><th class="px-3 py-2">الدفعة</th><th class="px-3 py-2">المبلغ</th><th class="px-3 py-2">التاريخ</th><th class="px-3 py-2">المؤشر</th>
              </tr></thead>
              <tbody id="fndDisbTbody"></tbody>
            </table>
          </div>
        </div>

        <div id="fnd-partners" class="fndTabView hidden">
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3" id="fndPartnersGrid"></div>
        </div>
      </div>
    </section>

    <!-- Other accounts (placeholders) -->
    <section id="account-emirate" class="view hidden"></section>
    <section id="account-gov" class="view hidden"></section>
    <section id="account-nonprofit" class="view hidden"></section>
    <section id="account-uni" class="view hidden"></section>
    <section id="account-people" class="view hidden"></section>
    <section id="account-speakers" class="view hidden"></section>
    <section id="account-admin" class="view hidden"></section>

  </main>
</div>

<!-- Footer -->
<footer class="mt-6 py-6 border-t">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-wrap items-center justify-between gap-4">
    <div class="text-sm text-slate-500">© حصيف — جميع الحقوق محفوظة</div>
    <div class="flex items-center gap-3 opacity-70">
      <span class="text-sm">VISION 2030</span>
      <span class="text-sm">مبادرة تلبية</span>
    </div>
  </div>
</footer>

<!-- Drawer -->
<div id="drawerDynamic" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/30" data-close-drawer></div>
  <div class="absolute left-0 top-0 bottom-0 w-full max-w-xl bg-white shadow-2xl p-6 overflow-y-auto">
    <div class="flex items-center justify-between sticky top-0 bg-white pb-3">
      <h3 id="drawerTitle" class="text-lg font-semibold">نموذج</h3>
      <button class="p-2 hover:bg-slate-100 rounded-lg" data-close-drawer><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    <form id="drawerForm" class="space-y-4 mt-3"></form>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-6 right-6 px-4 py-3 rounded-xl2 bg-emerald-600 text-white text-sm shadow-soft hidden">تم</div>

<script>
/* ===== Helpers ===== */
const $=(q,c=document)=>c.querySelector(q), $$=(q,c=document)=>Array.from(c.querySelectorAll(q));
function toast(m){const el=$('#toast');el.textContent=m;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),1800);}

/* ===== RBAC & Storage ===== */
const DB={get:(k,f=[])=>JSON.parse(localStorage.getItem(k)||JSON.stringify(f)),set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
function setRole(role){localStorage.setItem('me',JSON.stringify({role}));applyRoleUI();}
function getRole(){return (JSON.parse(localStorage.getItem('me')||'{}').role)||'viewer';}
function can(action){
  const role=getRole();
  const R={
    'create_project':['editor','manager','admin'],
    'approve_event':['manager','admin'],
    'manage_users':['admin'],
    'create_grant':['editor','manager','admin'],
    'create_volunteer':['editor','manager','admin']
  };
  return (R[action]||[]).includes(role);
}
function applyRoleUI(){ $('#btnNewProject').disabled=!can('create_project'); $('#btnNewEvent').disabled=!can('create_project'); }

/* ===== Seed data ===== */
if(!DB.get('projects').length) DB.set('projects',[
  { id:1, name:'مختبر ابتكار اجتماعي', sector:'جامعات',   region:'حائل',        program:'جودة الحياة',           fund:250000, status:'نشط' },
  { id:2, name:'تمكين الأسر المنتجة',  sector:'غير ربحي', region:'الرياض',       program:'التحول الوطني',         fund:180000, status:'قيد المراجعة' },
  { id:3, name:'مركز قيادة تطوعي',    sector:'حكومي',    region:'مكة المكرمة',  program:'تنمية القدرات البشرية', fund:320000, status:'نشط' },
  { id:4, name:'حاضنة أعمال ناشئة',   sector:'خاص',      region:'الرياض',       program:'تطوير القطاع المالي',   fund:400000, status:'مسودة' }
]);
if(!DB.get('events').length) DB.set('events',[]);
if(!DB.get('grants').length) DB.set('grants',[]);
if(!DB.get('volunteer').length) DB.set('volunteer',[]);
if(!DB.get('tickets').length) DB.set('tickets',[]);
if(!DB.get('keys').length) DB.set('keys',[]);
if(!DB.get('hooks').length) DB.set('hooks',[]);
if(!DB.get('users').length) DB.set('users',[
  {name:'مدير المنصة',role:'admin'},{name:'مسؤول مشاريع',role:'manager'},{name:'محرر',role:'editor'},{name:'قارئ',role:'viewer'}
]);
if(!DB.get('sso')) DB.set('sso',{issuer:'',client_id:'',client_secret:'',redirect:''});

/* ===== Mock API ===== */
const api={
  async listProjects(filter={}){let r=DB.get('projects'); if(filter.region) r=r.filter(x=>x.region===filter.region); if(filter.sector) r=r.filter(x=>x.sector===filter.sector); if(filter.program) r=r.filter(x=>x.program===filter.program); return r;},
  async createProject(p){const rows=DB.get('projects'); const id=(rows.at(-1)?.id||0)+1; rows.push({id,status:'مسودة',...p}); DB.set('projects',rows); return {ok:true};},
  async deleteProject(id){DB.set('projects',DB.get('projects').filter(r=>r.id!==id)); return {ok:true};},
  async listEvents(){return DB.get('events');}, async createEvent(p){const rows=DB.get('events'); rows.push(p); DB.set('events',rows); return {ok:true};},
  async listGrants(){return DB.get('grants');}, async createGrant(p){const rows=DB.get('grants'); rows.push(p); DB.set('grants',rows); return {ok:true};},
  async listVolunteer(){return DB.get('volunteer');}, async createVolunteer(p){const rows=DB.get('volunteer'); rows.push(p); DB.set('volunteer',rows); return {ok:true};}
};

/* ===== Sidebar / Routing ===== */
function switchView(id){
  $$('.view').forEach(v=>v.classList.add('hidden'));
  const view=$('#'+id); if(view) view.classList.remove('hidden');
  $$('#navMain .navlink').forEach(b=>b.classList.remove('bg-slate-100'));
  $(`#navMain .navlink[data-route="${id}"]`)?.classList.add('bg-slate-100');
  location.hash=id;
  if(id==='map') setTimeout(()=>{initMap(); mapInstance&&mapInstance.invalidateSize();},60);
  if(id==='reports') renderReports();
  if(id==='integrations') renderIntegrations();
  if(id==='admin-center'){renderUsers(); loadSSO();}
  if(id==='ai') initAIOnce();
  if(id==='account-private'){ pvt_bindTabs(); pvt_refresh(); }
  if(id==='account-funder'){ fnd_bindTabs(); fnd_refreshAll(); }
}
window.addEventListener('hashchange',()=>switchView(location.hash.replace('#','')||'dashboard'));

/* ===== Accounts & Modules ===== */
const accounts=[
  {key:'emirate',name_ar:'إمارة المنطقة',icon:'shield'},
  {key:'gov',name_ar:'جهة حكومية',icon:'building-2'},
  {key:'private',name_ar:'قطاع خاص',icon:'briefcase'},
  {key:'nonprofit',name_ar:'قطاع غير ربحي',icon:'heart'},
  {key:'uni',name_ar:'الجامعات',icon:'graduation-cap'},
  {key:'funder',name_ar:'جهات مانحة',icon:'wallet'},
  {key:'people',name_ar:'الأفراد',icon:'users'},
  {key:'speakers',name_ar:'مدربون/متحدثون',icon:'mic'},
  {key:'admin',name_ar:'حوكمة المنصة',icon:'settings'},
];
function renderAccounts(){
  const wrap=$('#accountsGrid'); wrap.innerHTML='';
  accounts.forEach(a=>{
    const b=document.createElement('button');
    b.className='flex items-center gap-2 px-3 py-2 rounded-lg border hover:bg-slate-50 text-sm';
    b.innerHTML=`<i data-lucide="${a.icon}" class="w-4 h-4"></i><span>${a.name_ar}</span>`;
    b.onclick=()=>switchView('account-'+a.key);
    wrap.appendChild(b);
  });
  lucide.createIcons();
}
function renderModules(){
  const wrap=$('#modulesGrid'); wrap.innerHTML='';
  const M={projects:'مشاريع',events:'فعاليات',jobs:'وظائف/تطوع',funding:'تمويل/منح',reports:'تقارير'};
  const I={projects:'folder-kanban',events:'calendar',jobs:'badge-check',funding:'credit-card',reports:'bar-chart-3'};
  Object.keys(M).forEach(k=>{
    const b=document.createElement('button');
    b.className='flex items-center gap-2 px-3 py-2 rounded-lg border hover:bg-slate-50 text-sm';
    b.innerHTML=`<i data-lucide="${I[k]}" class="w-4 h-4"></i><span>${M[k]}</span>`;
    b.onclick=()=>{ if(k==='projects') switchView('dashboard'); else if(k==='events') switchView('map'); else if(k==='reports') switchView('reports'); else toast('المكوّن: '+M[k]); };
    wrap.appendChild(b);
  });
  lucide.createIcons();
}

/* ===== KPIs + Projects table ===== */
async function renderKPIs(){
  const rows=await api.listProjects({});
  $('#kpiProjects').textContent=rows.length;
  $('#kpiFunding').textContent=rows.reduce((s,p)=>s+(+p.fund||0),0).toLocaleString('ar-EG');
  $('#kpiEvents').textContent=(await api.listEvents()).length;
  $('#kpiVol').textContent=(await api.listVolunteer()).length;
}
async function renderProjectsTable(){
  const region=$('#filterRegion').value, sector=$('#filterSector').value, program=$('#filterProgram').value;
  const q=$('#globalSearch').value.trim();
  let list=await api.listProjects({region,sector,program});
  if(q){ const terms=q.split(/\s+/); list=list.filter(p=>terms.every(t=>(p.name+p.sector+p.region+p.program+p.status).includes(t))); }
  const tb=$('#projectsTbody'); tb.innerHTML='';
  list.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class='px-3 py-3 font-medium'>${p.name}</td>
      <td class='px-3 py-3 text-slate-600'>${p.sector||'-'}</td>
      <td class='px-3 py-3 text-slate-600'>${p.region||'-'}</td>
      <td class='px-3 py-3 text-slate-600'>${p.program||'-'}</td>
      <td class='px-3 py-3 text-slate-600'>${(+p.fund||0).toLocaleString('ar-EG')}</td>
      <td class='px-3 py-3'><span class='tag ${p.status==='نشط'?'bg-emerald-100 text-emerald-700':p.status==='قيد المراجعة'?'bg-amber-100 text-amber-700':'bg-slate-100 text-slate-700'}'>${p.status||'-'}</span></td>
      <td class='px-3 py-3'><button class='p-2 rounded-lg hover:bg-slate-100' ${!can('create_project')?'disabled':''} data-del='${p.name}'><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=> b.onclick=async()=>{
    if(!can('create_project')) return;
    const name=b.dataset.del;
    DB.set('projects', DB.get('projects').filter(x=>x.name!==name));
    renderProjectsTable(); renderKPIs();
  });
  lucide.createIcons();
}

/* ===== Map ===== */
let mapInstance=null;
function initMap(){
  if(mapInstance){ mapInstance.invalidateSize(); return; }
  mapInstance=L.map('leafletMap').setView([23.8859,45.0792],5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap contributors'}).addTo(mapInstance);
  [{name:'حائل',lat:27.52,lng:41.69,count:12},{name:'الرياض',lat:24.71,lng:46.67,count:18},{name:'مكة',lat:21.39,lng:39.85,count:9}]
    .forEach(r=>L.marker([r.lat,r.lng]).addTo(mapInstance).bindPopup(`<div class="text-sm"><b>${r.name}</b><br>مشاريع: ${r.count}</div>`));
}

/* ===== Reports ===== */
async function renderReports(){
  const rows=await api.listProjects({});
  $('#repProjects').textContent=rows.length;
  $('#repFunding').textContent=rows.reduce((s,p)=>s+(+p.fund||0),0).toLocaleString('ar-EG');
  $('#repEvents').textContent=(await api.listEvents()).length;
  $('#repVol').textContent=(await api.listVolunteer()).length;
  const tb=$('#reportsTbody'); tb.innerHTML='';
  rows.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class='px-3 py-3 text-slate-500'>${i+1}</td>
      <td class='px-3 py-3 font-medium'>${p.name}</td>
      <td class='px-3 py-3 text-slate-600'>${p.sector||'-'}</td>
      <td class='px-3 py-3 text-slate-600'>${p.region||'-'}</td>
      <td class='px-3 py-3 text-slate-600'>${(+p.fund||0).toLocaleString('ar-EG')}</td>
      <td class='px-3 py-3'><span class='tag ${p.status==='نشط'?'bg-emerald-100 text-emerald-700':p.status==='قيد المراجعة'?'bg-amber-100 text-amber-700':'bg-slate-100 text-slate-700'}'>${p.status||'-'}</span></td>`;
    tb.appendChild(tr);
  });
}
document.addEventListener('click',(e)=>{
  if(e.target && e.target.id==='btnExportRptPDF'){
    const {jsPDF}=window.jspdf; const doc=new jsPDF();
    doc.setFontSize(14); doc.text('تقرير المشاريع',14,16);
    const head=[['#','المشروع','القطاع','المنطقة','التمويل','الحالة']];
    const body=Array.from(document.querySelectorAll('#reportsTbody tr')).map(tr=>Array.from(tr.querySelectorAll('td')).map(td=>td.innerText.trim()));
    doc.autoTable({head,body,startY:22,styles:{fontSize:10}}); doc.save('report.pdf');
  }
});
document.getElementById('btnExportRptXLSX').onclick=async()=>{
  const rows=await api.listProjects({});
  const data=[['#','Project','Sector','Region','Funding','Status']];
  rows.forEach((p,i)=>data.push([i+1,p.name,p.sector,p.region,p.fund,p.status]));
  const ws=XLSX.utils.aoa_to_sheet(data); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Report'); XLSX.writeFile(wb,'report.xlsx');
};
document.getElementById('csvUpload').addEventListener('change',async(e)=>{
  const f=e.target.files[0]; if(!f) return; const text=await f.text();
  const rows=text.split(/\r?\n/).slice(1).filter(Boolean).map(l=>l.split(','));
  const list=DB.get('projects');
  rows.forEach(r=>{ if(r.length>=6) list.push({name:r[0],sector:r[1],region:r[2],program:r[3],fund:+r[4]||0,status:r[5]||'مسودة'}); });
  DB.set('projects',list); toast('تم تحميل CSV'); renderReports(); renderProjectsTable(); renderKPIs(); e.target.value='';
});

/* ===== Drawer ===== */
function openDrawer(title,fields,onSubmit){
  $('#drawerTitle').textContent=title; const form=$('#drawerForm'); form.innerHTML='';
  fields.forEach(f=>{
    const w=document.createElement('div');
    if(f.type==='textarea') w.innerHTML=`<label class='text-sm block mb-1'>${f.label}</label><textarea name='${f.name}' rows='${f.rows||3}' class='rtl-input w-full border rounded-lg px-3 py-2' ${f.required?'required':''}></textarea>`;
    else if(f.type==='select') w.innerHTML=`<label class='text-sm block mb-1'>${f.label}</label><select name='${f.name}' class='rtl-input w-full border rounded-lg px-3 py-2'>${(f.options||[]).map(o=>`<option>${o}</option>`).join('')}</select>`;
    else w.innerHTML=`<label class='text-sm block mb-1'>${f.label}</label><input name='${f.name}' type='${f.type||"text"}' class='rtl-input w-full border rounded-lg px-3 py-2' ${f.min?`min='${f.min}'`:''} ${f.max?`max='${f.max}'`:''} ${f.step?`step='${f.step}'`:''} ${f.required?'required':''} placeholder='${f.placeholder||""}'/>`;
    form.appendChild(w);
  });
  const actions=document.createElement('div'); actions.className='pt-2 flex items-center gap-2';
  actions.innerHTML=`<button class='px-4 py-2 rounded-lg bg-primary text-white'>حفظ</button><button type='button' class='px-4 py-2 rounded-lg bg-slate-100' data-close-drawer>إلغاء</button>`;
  form.appendChild(actions);
  form.onsubmit=async(e)=>{ e.preventDefault(); const fd=new FormData(form); await onSubmit(Object.fromEntries(fd.entries())); closeDrawer(); toast('تم الحفظ'); };
  $('#drawerDynamic').classList.remove('hidden');
  $$('#drawerDynamic [data-close-drawer]').forEach(b=> b.onclick=closeDrawer);
  lucide.createIcons();
}
function closeDrawer(){ $('#drawerDynamic').classList.add('hidden'); }

/* ===== Quick create ===== */
document.getElementById('btnNewProject').onclick=()=>{
  if(!can('create_project')) return toast('ليس لديك صلاحية الإنشاء');
  openDrawer('مشروع جديد',[
    {name:'name',label:'اسم المشروع',required:true},
    {name:'sector',label:'القطاع',type:'select',options:['حكومي','خاص','غير ربحي','جامعات']},
    {name:'region',label:'المنطقة',type:'select',options:['حائل','الرياض','مكة المكرمة']},
    {name:'program',label:'برنامج الرؤية',type:'select',options:['جودة الحياة','التحول الوطني','تنمية القدرات البشرية','تطوير القطاع المالي','الصناعة الوطنية والخدمات اللوجستية','الإسكان']},
    {name:'fund',label:'قيمة التمويل (ر.س)',type:'number',min:0,step:1000},
    {name:'status',label:'الحالة',type:'select',options:['مسودة','قيد المراجعة','نشط']}
  ], async (p)=>{ await api.createProject(p); renderProjectsTable(); renderKPIs(); });
};
document.getElementById('btnNewEvent').onclick=()=>{
  openDrawer('فعالية جديدة',[
    {name:'title',label:'عنوان الفعالية',required:true},
    {name:'date',label:'التاريخ',type:'date',required:true},
    {name:'venue',label:'الموقع/المرفق'}
  ], async (p)=>{ await api.createEvent(p); renderKPIs(); });
};

/* ===== AI Lab ===== */
let aiInit=false;
function initAIOnce(){
  if(aiInit) return; aiInit=true;
  const feed=$('#aiFeed');
  function push(role,txt){ const p=document.createElement('p'); p.innerHTML=`<span class='font-semibold'>${role==='user'?'أنت':'حصيف'}</span>: ${txt}`; feed.appendChild(p); feed.scrollTop=feed.scrollHeight; }
  function reply(q){
    const t=q.toLowerCase();
    if(q.includes('مؤشر')||t.includes('kpi')) return 'أمثلة: عدد المستفيدين، تكلفة لكل مستفيد، نسبة التوظيف بعد البرنامج، درجة الرضا، الاستدامة (12 شهرًا).';
    if(q.includes('هيكل')||q.includes('تقرير')) return 'هيكل مقترح: ملخص تنفيذي، المنهجية، البيانات، التحليل، الأثر، التوصيات، الملاحق.';
    if(q.includes('إعلان')||q.includes('فعالية')) return 'نص مختصر: ندعوكم لفعالية تطوعية في حائل يوم الجمعة 7:00م، للتسجيل عبر المنصة — الأماكن محدودة.';
    return 'تم — هذه إجابة افتراضية. يمكن ربط المختبر لاحقًا بمحرك ذكاء اصطناعي فعلي.';
  }
  $('#aiSend').onclick=()=>{ const q=$('#aiInput').value.trim(); if(!q) return; push('user',q); $('#aiInput').value=''; setTimeout(()=> push('assistant', reply(q)),300); };
  $$('[data-ai-template]').forEach(b=> b.onclick=()=>{ $('#aiInput').value=b.getAttribute('data-ai-template'); $('#aiSend').click(); });
}

/* ===== Integrations ===== */
function renderIntegrations(){
  const keys=DB.get('keys'); const wrap=$('#keysWrap'); wrap.innerHTML='';
  keys.forEach((k,i)=>{
    const row=document.createElement('div');
    row.className='flex items-center justify-between bg-slate-50 rounded-lg px-3 py-2';
    row.innerHTML=`<code class='text-xs break-all'>${k}</code><button class='px-2 py-1 rounded bg-slate-100 text-xs' data-del-key='${i}'>حذف</button>`;
    wrap.appendChild(row);
  });
  wrap.querySelectorAll('[data-del-key]').forEach(btn=> btn.onclick=()=>{
    const idx=+btn.dataset.delKey; const arr=DB.get('keys'); arr.splice(idx,1); DB.set('keys',arr); renderIntegrations();
  });
  const hooks=DB.get('hooks'); const hw=$('#hooksWrap'); hw.innerHTML='';
  hooks.forEach((u,i)=>{
    const row=document.createElement('div');
    row.className='flex items-center justify-between bg-slate-50 rounded-lg px-3 py-2';
    row.innerHTML=`<span class='text-xs'>${u}</span><button class='px-2 py-1 rounded bg-slate-100 text-xs' data-del-hook='${i}'>حذف</button>`;
    hw.appendChild(row);
  });
  hw.querySelectorAll('[data-del-hook]').forEach(b=> b.onclick=()=>{
    const idx=+b.dataset.delHook; const arr=DB.get('hooks'); arr.splice(idx,1); DB.set('hooks',arr); renderIntegrations();
  });
}
document.addEventListener('click',(e)=>{
  if(e.target && e.target.id==='btnGenKey'){
    const token=Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);
    const arr=DB.get('keys'); arr.push('hasseef_'+token); DB.set('keys',arr); renderIntegrations();
  }
});
document.getElementById('hookForm')?.addEventListener('submit',(e)=>{
  if(e.target && e.target.id==='hookForm'){ e.preventDefault();
    const url=new FormData(e.target).get('url').trim(); if(!url) return;
    const arr=DB.get('hooks'); arr.push(url); DB.set('hooks',arr); e.target.reset(); renderIntegrations();
  }
});

/* ===== Admin center ===== */
function renderUsers(){
  const tb=$('#usersTbody'); if(!tb) return; tb.innerHTML='';
  DB.get('users').forEach((u,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class='px-3 py-2 font-medium'>${u.name}</td>
      <td class='px-3 py-2'>${u.role}</td>
      <td class='px-3 py-2'>
        <button class='px-2 py-1 rounded bg-slate-100 text-xs' data-promote='${i}'>ترقية</button>
        <button class='px-2 py-1 rounded bg-slate-100 text-xs' data-demote='${i}'>تخفيض</button>
        <button class='px-2 py-1 rounded bg-slate-100 text-xs' data-del='${i}'>حذف</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{
    const arr=DB.get('users'); arr.splice(+b.dataset.del,1); DB.set('users',arr); renderUsers();
  });
  const order=['viewer','editor','manager','admin'];
  tb.querySelectorAll('[data-promote]').forEach(b=> b.onclick=()=>{
    const arr=DB.get('users'); const u=arr[+b.dataset.promote]; const idx=order.indexOf(u.role);
    u.role=order[Math.min(order.length-1,idx+1)]; DB.set('users',arr); renderUsers();
  });
  tb.querySelectorAll('[data-demote]').forEach(b=> b.onclick=()=>{
    const arr=DB.get('users'); const u=arr[+b.dataset.demote]; const idx=order.indexOf(u.role);
    u.role=order[Math.max(0,idx-1)]; DB.set('users',arr); renderUsers();
  });
}
document.getElementById('userAddForm')?.addEventListener('submit',(e)=>{
  if(e.target && e.target.id==='userAddForm'){ e.preventDefault();
    const fd=new FormData(e.target); const arr=DB.get('users');
    arr.push({name:fd.get('name')||'مستخدم',role:fd.get('role')}); DB.set('users',arr); e.target.reset(); renderUsers();
  }
});
function loadSSO(){
  const s=DB.get('sso'); const f=$('#ssoForm'); if(!f) return;
  f.issuer.value=s.issuer||''; f.client_id.value=s.client_id||''; f.client_secret.value=s.client_secret||''; f.redirect.value=s.redirect||'';
}
document.getElementById('ssoForm')?.addEventListener('submit',(e)=>{
  if(e.target && e.target.id==='ssoForm'){ e.preventDefault();
    const fd=new FormData(e.target);
    const conf={issuer:fd.get('issuer'),client_id:fd.get('client_id'),client_secret:fd.get('client_secret'),redirect:fd.get('redirect')};
    DB.set('sso',conf); toast('تم حفظ إعدادات SSO');
  }
});

/* ===== Private Account ===== */
if(!DB.get('pvt_partners').length) DB.set('pvt_partners',[
  {name:'شركة لوجستية',note:'سلاسل الإمداد'},{name:'شركة تقنية',note:'منصات رقمية'},{name:'مركز تدريب',note:'رفع المهارات'}
]);
if(!DB.get('pvt_requests').length) DB.set('pvt_requests',[]);
function pvt_listMyProjects(){ return DB.get('projects').filter(p=>p.sector==='خاص'); }
function pvt_renderKPIs(){ const rows=pvt_listMyProjects(); $('#pvtKpiProjects').textContent=rows.length; $('#pvtKpiFunding').textContent=rows.reduce((s,p)=>s+(+p.fund||0),0).toLocaleString('ar-EG'); $('#pvtKpiPartners').textContent=DB.get('pvt_partners').length; $('#pvtKpiPending').textContent=DB.get('pvt_requests').length; }
function pvt_renderPartners(){ const wrap=$('#pvtPartners'); if(!wrap) return; wrap.innerHTML=''; DB.get('pvt_partners').forEach(pr=>{ const row=document.createElement('div'); row.className='flex items-center justify-between bg-slate-50 rounded-lg px-3 py-2'; row.innerHTML=`<div><div class="font-medium">${pr.name}</div><div class="text-xs text-slate-500">${pr.note||''}</div></div>`; wrap.appendChild(row); }); }
function pvt_renderProjectsTable(){ const list=pvt_listMyProjects(); const tb=$('#pvtProjectsTbody'); if(!tb) return; tb.innerHTML=''; list.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class='px-3 py-3 font-medium'>${p.name}</td><td class='px-3 py-3 text-slate-600'>${p.region||'-'}</td><td class='px-3 py-3 text-slate-600'>${p.program||'-'}</td><td class='px-3 py-3 text-slate-600'>${(+p.fund||0).toLocaleString('ar-EG')}</td><td class='px-3 py-3'><span class='tag ${p.status==='نشط'?'bg-emerald-100 text-emerald-700':p.status==='قيد المراجعة'?'bg-amber-100 text-amber-700':'bg-slate-100 text-slate-700'}'>${p.status||'-'}</span></td><td class='px-3 py-3'><button class='p-2 rounded-lg hover:bg-slate-100' data-pvt-del='${p.name}'><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>`; tb.appendChild(tr); }); tb.querySelectorAll('[data-pvt-del]').forEach(b=> b.onclick=()=>{ if(!can('create_project')) return; const name=b.dataset.pvtDel; DB.set('projects', DB.get('projects').filter(x=>x.name!==name)); pvt_refresh(); }); lucide.createIcons(); }
function pvt_renderPartnershipsGrid(){ const grid=$('#pvtPartnershipsGrid'); if(!grid) return; grid.innerHTML=''; DB.get('pvt_partners').forEach(pr=>{ const card=document.createElement('div'); card.className='border rounded-xl p-4 bg-white'; card.innerHTML=`<div class="font-semibold mb-1">${pr.name}</div><div class="text-sm text-slate-600">${pr.note||''}</div><div class="mt-3"><button class="px-3 py-2 rounded-lg bg-primary text-white text-xs">بدء تعاون</button></div>`; grid.appendChild(card); }); }
function pvt_renderReqList(){ const wrap=$('#pvtReqList'); if(!wrap) return; wrap.innerHTML=''; DB.get('pvt_requests').forEach((r,i)=>{ const row=document.createElement('div'); row.className='flex items-center justify-between bg-slate-50 rounded-lg px-3 py-2'; row.innerHTML=`<div><div class="font-medium">${r.title}</div><div class="text-xs text-slate-500">${r.type||''}</div></div><button class="px-2 py-1 rounded bg-slate-100 text-xs" data-req-del="${i}">حذف</button>`; wrap.appendChild(row); }); wrap.querySelectorAll('[data-req-del]').forEach(b=> b.onclick=()=>{ const idx=+b.dataset.reqDel; const arr=DB.get('pvt_requests'); arr.splice(idx,1); DB.set('pvt_requests',arr); pvt_renderReqList(); pvt_renderKPIs(); }); }
function pvt_refresh(){ pvt_renderKPIs(); pvt_renderPartners(); pvt_renderProjectsTable(); pvt_renderPartnershipsGrid(); pvt_renderReqList(); }
function pvt_bindTabs(){ $$('.pvtTab').forEach(btn=>{ btn.onclick=()=>{ $$('.pvtTab').forEach(b=> b.classList.remove('bg-slate-900','text-white')); btn.classList.add('bg-slate-900','text-white'); const to=btn.dataset.tab; $$('.pvtTabView').forEach(v=> v.classList.add('hidden')); $('#'+to).classList.remove('hidden'); }; }); }
document.getElementById('pvtReqForm')?.addEventListener('submit',(e)=>{ if(e.target && e.target.id==='pvtReqForm'){ e.preventDefault(); const fd=new FormData(e.target); const arr=DB.get('pvt_requests'); arr.push({title:fd.get('title'),type:fd.get('type')}); DB.set('pvt_requests',arr); e.target.reset(); pvt_renderReqList(); pvt_renderKPIs(); }});
document.addEventListener('click',(e)=>{
  if(e.target && e.target.id==='btnPrivateNewProject'){
    if(!can('create_project')) return toast('ليس لديك صلاحية الإنشاء');
    openDrawer('مشروع جديد (القطاع الخاص)',[
      {name:'name',label:'اسم المشروع',required:true},
      {name:'region',label:'المنطقة',type:'select',options:['حائل','الرياض','مكة المكرمة']},
      {name:'program',label:'برنامج الرؤية',type:'select',options:['جودة الحياة','التحول الوطني','تنمية القدرات البشرية','تطوير القطاع المالي','الصناعة الوطنية والخدمات اللوجستية','الإسكان']},
      {name:'fund',label:'قيمة التمويل (ر.س)',type:'number',min:0,step:1000},
      {name:'status',label:'الحالة',type:'select',options:['مسودة','قيد المراجعة','نشط']},
      {name:'desc',label:'وصف موجز',type:'textarea',rows:3}
    ], async (p)=>{ await api.createProject({sector:'خاص',...p}); pvt_refresh(); renderProjectsTable(); renderKPIs(); });
  }
});

/* ===== Funder Account ===== */
if(!DB.get('fnd_calls').length) DB.set('fnd_calls',[
  {title:'تمكين الأسر المنتجة',sector:'غير ربحي',cap:300000,deadline:'2025-12-31',status:'مفتوحة'},
  {title:'رقمنة الخدمات المجتمعية',sector:'جامعات',cap:500000,deadline:'2026-02-28',status:'مفتوحة'}
]);
if(!DB.get('fnd_apps').length) DB.set('fnd_apps',[
  {org:'جمعية أثر',title:'متجر حرفي رقمي',amount:120000,status:'قيد المراجعة'},
  {org:'مركز ابتكار',title:'نظام متطوعين',amount:90000,status:'مقبول'}
]);
if(!DB.get('fnd_disb').length) DB.set('fnd_disb',[
  {grant:'تمكين الأسر',tranche:'دفعة 1',amount:40000,date:'2025-09-10',kpi:'100 مستفيد'},
  {grant:'متجر حرفي',tranche:'دفعة 1',amount:30000,date:'2025-09-20',kpi:'بدء التشغيل'}
]);
if(!DB.get('fnd_partners').length) DB.set('fnd_partners',[
  {name:'بنك التنمية',note:'برامج تمويل صغيرة'},
  {name:'غرفة تجارية',note:'تشبيك منشآت'}
]);
function fnd_refreshKPIs(){
  const calls=DB.get('fnd_calls').filter(c=>c.status==='مفتوحة').length;
  const pledged=DB.get('fnd_apps').reduce((s,a)=>s+(+a.amount||0),0);
  const disb=DB.get('fnd_disb').reduce((s,d)=>s+(+d.amount||0),0);
  const pending=DB.get('fnd_apps').filter(a=>a.status==='قيد المراجعة').length;
  $('#fndKpiActiveGrants').textContent=calls;
  $('#fndKpiPledged').textContent=pledged.toLocaleString('ar-EG');
  $('#fndKpiDisbursed').textContent=disb.toLocaleString('ar-EG');
  $('#fndKpiPending').textContent=pending;
}
function fnd_renderCalls(){
  const grid=$('#fndCallsGrid'); if(!grid) return; grid.innerHTML='';
  DB.get('fnd_calls').forEach(c=>{
    const card=document.createElement('div'); card.className='border rounded-xl p-4 bg-white';
    card.innerHTML=`<div class="font-semibold mb-1">${c.title}</div>
      <div class="text-sm text-slate-600">القطاع: ${c.sector} • السقف: ${(+c.cap).toLocaleString('ar-EG')} • حتى ${c.deadline}</div>
      <div class="mt-3 flex items-center gap-2">
        <span class="tag ${c.status==='مفتوحة'?'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-700'}">${c.status}</span>
        <button class="px-3 py-2 rounded-lg bg-slate-900 text-white text-xs" data-apply="${c.title}">تقديم طلب</button>
      </div>`;
    grid.appendChild(card);
  });
  grid.querySelectorAll('[data-apply]').forEach(b=> b.onclick=()=>{
    if(!can('create_grant')) return toast('ليس لديك صلاحية التقديم');
    openDrawer('طلب تمويل — '+b.dataset.apply,[
      {name:'org',label:'الجهة المتقدمة',required:true},
      {name:'title',label:'عنوان المشروع',required:true},
      {name:'amount',label:'المبلغ المطلوب (ر.س)',type:'number',min:0,step:1000},
      {name:'desc',label:'وصف موجز',type:'textarea',rows:3}
    ], async (p)=>{
      const apps=DB.get('fnd_apps'); apps.push({org:p.org,title:p.title,amount:+p.amount||0,status:'قيد المراجعة'});
      DB.set('fnd_apps',apps); fnd_renderApps(); fnd_refreshKPIs();
    });
  });
}
function fnd_renderApps(){
  const tb=$('#fndAppsTbody'); if(!tb) return; tb.innerHTML='';
  DB.get('fnd_apps').forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="px-3 py-3 font-medium">${a.org}</td>
      <td class="px-3 py-3">${a.title}</td>
      <td class="px-3 py-3 text-slate-600">${(+a.amount||0).toLocaleString('ar-EG')}</td>
      <td class="px-3 py-3"><span class="tag ${a.status==='مقبول'?'bg-emerald-100 text-emerald-700':a.status==='مرفوض'?'bg-rose-100 text-rose-700':'bg-amber-100 text-amber-700'}">${a.status}</span></td>
      <td class="px-3 py-3">
        <button class="px-2 py-1 rounded bg-slate-100 text-xs" data-approve="${a.title}">قبول</button>
        <button class="px-2 py-1 rounded bg-slate-100 text-xs" data-reject="${a.title}">رفض</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-approve]').forEach(b=> b.onclick=()=>{
    const apps=DB.get('fnd_apps'); const it=apps.find(x=>x.title===b.dataset.approve);
    if(it){ it.status='مقبول'; DB.set('fnd_apps',apps); fnd_renderApps(); fnd_refreshKPIs(); }
  });
  tb.querySelectorAll('[data-reject]').forEach(b=> b.onclick=()=>{
    const apps=DB.get('fnd_apps'); const it=apps.find(x=>x.title===b.dataset.reject);
    if(it){ it.status='مرفوض'; DB.set('fnd_apps',apps); fnd_renderApps(); fnd_refreshKPIs(); }
  });
}
function fnd_renderDisb(){
  const tb=$('#fndDisbTbody'); if(!tb) return; tb.innerHTML='';
  DB.get('fnd_disb').forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="px-3 py-3 font-medium">${d.grant}</td>
      <td class="px-3 py-3">${d.tranche}</td>
      <td class="px-3 py-3 text-slate-600">${(+d.amount||0).toLocaleString('ar-EG')}</td>
      <td class="px-3 py-3 text-slate-600">${d.date}</td>
      <td class="px-3 py-3 text-slate-600">${d.kpi}</td>`;
    tb.appendChild(tr);
  });
}
function fnd_renderPartners(){
  const grid=$('#fndPartnersGrid'); if(!grid) return; grid.innerHTML='';
  DB.get('fnd_partners').forEach(pr=>{
    const card=document.createElement('div');
    card.className='border rounded-xl p-4 bg-white';
    card.innerHTML=`<div class="font-semibold mb-1">${pr.name}</div><div class="text-sm text-slate-600">${pr.note||''}</div>`;
    grid.appendChild(card);
  });
}
function fnd_bindTabs(){
  $$('.fndTab').forEach(btn=>{
    btn.onclick=()=>{
      $$('.fndTab').forEach(b=> b.classList.remove('bg-slate-900','text-white'));
      btn.classList.add('bg-slate-900','text-white');
      const to=btn.dataset.tab;
      $$('.fndTabView').forEach(v=> v.classList.add('hidden'));
      $('#'+to).classList.remove('hidden');
    };
  });
}
function fnd_refreshAll(){ fnd_refreshKPIs(); fnd_renderCalls(); fnd_renderApps(); fnd_renderDisb(); fnd_renderPartners(); }
document.addEventListener('click',(e)=>{
  if(e.target && e.target.id==='btnFndNewCall'){
    if(!can('create_grant')) return toast('ليس لديك صلاحية الإنشاء');
    openDrawer('دعوة تمويل جديدة',[
      {name:'title',label:'عنوان الدعوة',required:true},
      {name:'sector',label:'الفئة المستهدفة',type:'select',options:['حكومي','خاص','غير ربحي','جامعات']},
      {name:'cap',label:'السقف المالي (ر.س)',type:'number',min:0,step:10000},
      {name:'deadline',label:'آخر موعد للتقديم',type:'date',required:true}
    ], async (p)=>{
      const calls=DB.get('fnd_calls'); calls.push({title:p.title,sector:p.sector,cap:+p.cap||0,deadline:p.deadline,status:'مفتوحة'});
      DB.set('fnd_calls',calls); fnd_refreshAll();
    });
  }
});

/* ===== Language & Role ===== */
document.getElementById('btnAR').onclick=()=>{document.documentElement.lang='ar'; document.documentElement.dir='rtl'; toast('تم التبديل للعربية');};
document.getElementById('btnEN').onclick=()=>{document.documentElement.lang='en'; document.documentElement.dir='ltr'; toast('Switched to English');};
const roleSel=document.getElementById('roleSelect'); roleSel.value=getRole(); roleSel.onchange=()=>setRole(roleSel.value);

/* ===== Filters + Search ===== */
$('#filterRegion').onchange=renderProjectsTable;
$('#filterSector').onchange=renderProjectsTable;
$('#filterProgram').onchange=renderProjectsTable;
$('#btnResetFilters').onclick=()=>{$('#filterRegion').value='';$('#filterSector').value='';$('#filterProgram').value='';$('#globalSearch').value='';renderProjectsTable();};
$('#globalSearch').addEventListener('input',renderProjectsTable);

/* ===== Init ===== */
function renderAccountsAndModules(){ renderAccounts(); renderModules(); }
function init(){ renderAccountsAndModules(); renderKPIs(); renderProjectsTable(); switchView(location.hash.replace('#','')||'dashboard'); lucide.createIcons(); applyRoleUI(); }
init();
</script>
</body>
</html>
