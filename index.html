<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حصيف — المنصة المتكاملة</title>
  <meta name="color-scheme" content="light dark" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT: '#5AA044' },
            accent:  { DEFAULT: '#F8BE43' },
            ink:     { DEFAULT: '#0f172a' },
            stone:   { DEFAULT: '#f8fafc' }
          },
          boxShadow: { soft: '0 10px 20px rgba(2,6,23,.08)' },
          borderRadius: { xl2: '1rem' }
        }
      }
    }
  </script>
  <!-- Icons + Maps + Export libs -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    .scroll-slim::-webkit-scrollbar{width:8px;height:8px}
    .scroll-slim::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:8px}
    .rtl-input { direction: rtl; }
    table { border-collapse: separate; border-spacing: 0 8px; }
    thead th { font-weight:600; color:#0f172a; }
    tbody tr { background:#fff; box-shadow: 0 1px 2px rgba(2,6,23,.05); }
    tbody td { border-top: 1px solid #f1f5f9; border-bottom:1px solid #f1f5f9; }
    tbody td:first-child { border-right:1px solid #f1f5f9; border-radius: .5rem 0 0 .5rem; }
    tbody td:last-child { border-left:1px solid #f1f5f9; border-radius: 0 .5rem .5rem 0; }
    #leafletMap { height: 360px; }
    .tag { padding:.25rem .5rem; border-radius:9999px; font-size:.75rem; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.75rem; background:#e2e8f0; padding:.1rem .35rem; border-radius:.375rem; }
    .prose-chat p { margin: .25rem 0; }
    /* شعار نصي SVG بحجم مناسب */
    .logo-vision, .logo-talbiya, .logo-hasseef { display:block }
    .logo-vision { height: 28px }
    .logo-talbiya { height: 36px }
    .logo-hasseef { height: 52px }
    @media (max-width: 640px){
      .logo-vision{height:22px}
      .logo-talbiya{height:28px}
      .logo-hasseef{height:42px}
    }
    @media (min-width: 1024px){
      .logo-vision{height:30px}
      .logo-talbiya{height:38px}
      .logo-hasseef{height:58px}
    }
  </style>
</head>
<body class="bg-stone text-ink antialiased">

  <!-- Header -->
  <header class="sticky top-0 z-40 shadow-soft bg-slate-900 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-wrap items-center gap-3">
      <!-- Right: Hasseef (يمين) -->
      <div class="flex items-center gap-2 order-1 md:order-1">
        <!-- شعار حصيف (SVG نصي مبدئي) -->
        <svg class="logo-hasseef" viewBox="0 0 420 100" aria-label="حصيف">
          <rect rx="14" ry="14" width="420" height="100" fill="white" opacity="0.08"></rect>
          <text x="210" y="62" text-anchor="middle" font-size="46" font-family="Tajawal, system-ui" fill="#FFFFFF">حَصيف</text>
        </svg>
        <div class="leading-5 hidden sm:block">
          <div class="font-semibold">حصيف</div>
          <div class="text-xs text-slate-200">منصة تكامل تنموي مرتبطة برؤية 2030</div>
        </div>
      </div>

      <div class="flex-1 order-2"></div>

      <!-- Center controls -->
      <div class="order-3 flex items-center gap-3 w-full max-w-3xl">
        <div class="flex items-center gap-2">
          <button id="btnAR" class="px-2 py-1 rounded-lg bg-white/10 text-white text-xs hover:bg-white/20">عربي</button>
          <button id="btnEN" class="px-2 py-1 rounded-lg bg-white/10 text-white text-xs hover:bg-white/20">English</button>
        </div>
        <div class="relative flex-1">
          <input id="globalSearch" type="search" class="rtl-input w-full rounded-xl2 border border-white/20 bg-white/10 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-primary/40 px-4 py-2 text-sm"
            placeholder="ابحث عن: مشروع، فعالية، وظيفة، منحة، مرفق..." />
          <button class="absolute left-2 top-1/2 -translate-y-1/2 text-white" aria-label="Search"><i data-lucide="search" class="w-5 h-5"></i></button>
        </div>
        <div class="flex items-center gap-2 text-xs">
          <span class="text-slate-200">الدور:</span>
          <select id="roleSelect" class="rtl-input border border-white/20 bg-white/10 text-white rounded-lg px-2 py-1 text-xs">
            <option value="viewer">Viewer</option>
            <option value="editor">Editor</option>
            <option value="manager">Manager</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button id="btnNotifications" class="relative p-2 rounded-xl2 hover:bg-white/10 transition text-white" aria-label="Notifications">
          <i data-lucide="bell" class="w-5 h-5"></i>
          <span class="absolute -top-1 -right-1 bg-primary text-white text-[10px] leading-4 rounded-full px-1.5">3</span>
        </button>
      </div>

      <!-- Left: Vision 2030 + Talbiya (أقصى اليسار) -->
      <div class="order-4 flex items-center gap-3">
        <!-- شعار رؤية 2030 (SVG نصي بسيط) -->
        <svg class="logo-vision" viewBox="0 0 240 48" aria-label="Vision 2030">
          <text x="0" y="34" font-size="28" font-family="Inter, system-ui" fill="#FFFFFF" opacity="0.95">VISION 2030</text>
        </svg>
        <!-- شعار مبادرة تلبية (SVG نصي بسيط) -->
        <svg class="logo-talbiya" viewBox="0 0 240 60" aria-label="مبادرة تلبية">
          <text x="120" y="40" text-anchor="middle" font-size="28" font-family="Tajawal, system-ui" fill="#FFFFFF" opacity="0.95">مبادرة تلبية</text>
        </svg>
      </div>
    </div>
  </header>

  <!-- Layout -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-12 gap-6">

    <!-- Sidebar -->
    <aside class="col-span-12 md:col-span-3 lg:col-span-3">
      <div class="bg-white rounded-2xl shadow-soft p-4 space-y-4">

        <div>
          <div class="text-xs font-semibold text-slate-500 mb-2">القسم العام</div>
          <nav class="space-y-1" id="navMain">
            <button data-route="dashboard" class="navlink w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50">
              <span class="flex items-center gap-2"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> <span>الرئيسية</span></span>
              <span class="text-xs text-slate-400"><span class="kbd">Alt</span>+<span class="kbd">1</span></span>
            </button>
            <button data-route="map" class="navlink w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50">
              <span class="flex items-center gap-2"><i data-lucide="map" class="w-4 h-4"></i> <span>خريطة المشاريع</span></span>
            </button>
            <button data-route="stories" class="navlink w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-slate-50">
              <span class="flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> <span>قصص الأثر</span></span>
            </button>
            <button data-route="reports" class="navlink w-full flex items-center justify_between px-3 py-2 rounded-lg hover:bg-slate-50">
              <span class="flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> <span>التقارير</span></span>
            </button>
            <button data-route="ai" class="navlink w-full flex items-center justify_between px-3 py-2 rounded-lg hover:bg-slate-50">
              <span class="flex items-center gap-2"><i data-lucide="bot" class="w-4 h-4"></i> <span>مختبر الذكاء الاصطناعي</span></span>
            </button>
            <button data-route="integrations" class="navlink w-full flex items-center justify_between px-3 py-2 rounded-lg hover:bg-slate-50">
              <span class="flex items-center gap-2"><i data-lucide="plug" class="w-4 h-4"></i> <span>التكاملات</span></span>
            </button>
            <button data-route="admin-center" class="navlink w-full flex items-center justify_between px-3 py-2 rounded-lg hover:bg-slate-50">
              <span class="flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> <span>مركز الإدارة</span></span>
            </button>
          </nav>
        </div>

        <div class="pt-2">
          <div class="text-xs font-semibold text-slate-500 mb-2">الحسابات</div>
          <div class="grid grid-cols-2 gap-2" id="accountsGrid"></div>
        </div>

        <div class="pt-2">
          <div class="text-xs font-semibold text-slate-500 mb-2">المكوّنات</div>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-2" id="modulesGrid"></div>
        </div>

      </div>

      <div class="mt-4 bg-white rounded-2xl shadow-soft p-4">
        <div class="text-xs font-semibold text-slate-500 mb-2">إجراءات سريعة</div>
        <div class="grid grid-cols-2 gap-2">
          <button id="btnNewProject" class="px-3 py-2 rounded-lg text-sm bg-primary text-white hover:opacity-95">+ مشروع</button>
          <button id="btnNewEvent" class="px-3 py-2 rounded-lg text-sm bg-slate-900 text-white hover:opacity-90">+ فعالية</button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="col-span-12 md:col-span-9 lg:col-span-9 space-y-6">

      <!-- Dashboard -->
      <section id="dashboard" class="view">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500">المشاريع النشطة</div><div id="kpiProjects" class="text-2xl font-bold mt-1">—</div></div>
          <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500">قيمة التمويل (ر.س)</div><div id="kpiFunding" class="text-2xl font-bold mt-1">—</div></div>
          <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500">الفعاليات القادمة</div><div id="kpiEvents" class="text-2xl font-bold mt-1">—</div></div>
          <div class="bg-white rounded-2xl p-4 shadow-soft"><div class="text-xs text-slate-500">فرص التطوع</div><div id="kpiVol" class="text-2xl font-bold mt-1">—</div></div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-soft mt-4">
          <div class="flex flex-wrap items-center gap-2">
            <select id="filterRegion" class="rtl-input border rounded-lg px-3 py-2 text-sm">
              <option value="">كل المناطق</option>
              <option>حائل</option><option>الرياض</option><option>مكة المكرمة</option>
            </select>
            <select id="filterSector" class="rtl-input border rounded-lg px-3 py-2 text-sm">
              <option value="">كل القطاعات</option>
              <option>حكومي</option><option>خاص</option><option>غير ربحي</option><option>جامعات</option>
            </select>
            <select id="filterProgram" class="rtl-input border rounded-lg px-3 py-2 text-sm">
              <option value="">برامج الرؤية</option>
              <option>التحول الوطني</option><option>جودة الحياة</option><option>تنمية القدرات البشرية</option>
              <option>تطوير القطاع المالي</option><option>الصناعة الوطنية والخدمات اللوجستية</option><option>الإسكان</option>
            </select>
            <div class="flex-1"></div>
            <button id="btnExportPDF" class="text-sm px-3 py-2 rounded-lg bg-slate-900 text-white">تصدير PDF</button>
            <button id="btnExportXLSX" class="text-sm px-3 py-2 rounded-lg bg-slate-100">تصدير Excel</button>
            <button id="btnResetFilters" class="text-sm px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">إعادة الضبط</button>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-soft mt-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">المشاريع</div>
            <div class="text-xs text-slate-500">نموذج عرض — للتجربة</div>
          </div>
          <div class="overflow-auto scroll-slim">
            <table class="w-full text-sm" id="projectsTable">
              <thead>
                <tr class="text-right text-slate-500">
                  <th class="px-3 py-2">المشروع</th>
                  <th class="px-3 py-2">القطاع</th>
                  <th class="px-3 py-2">المنطقة</th>
                  <th class="px-3 py-2">البرنامج</th>
                  <th class="px-3 py-2">التمويل (ر.س)</th>
                  <th class="px-3 py-2">الحالة</th>
                  <th class="px-3 py-2"></th>
                </tr>
              </thead>
              <tbody id="projectsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Map -->
      <section id="map" class="view hidden">
        <div class="bg-white rounded-2xl p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">خريطة المشاريع</h2>
            <div class="text-xs text-slate-500">© <a href="https://www.openstreetmap.org/copyright" target="_blank" class="underline">OpenStreetMap</a>, © Leaflet</div>
          </div>
          <div class="mt-4" id="leafletMap" class="rounded-xl2"></div>
          <div class="mt-3 text-xs text-slate-500">الخريطة تجريبية وتعرض مؤشرات عدد المشاريع لكل منطقة.</div>
        </div>
      </section>

      <!-- Stories -->
      <section id="stories" class="view hidden">
        <div class="bg-white rounded-2xl p-6 shadow-soft">
          <h2 class="text-lg font-semibold mb-3">قصص أثر مختارة</h2>
          <div id="storiesWrap" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
      </section>

      <!-- Reports -->
      <section id="reports" class="view hidden">
        <div class="bg-white rounded-2xl p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">التقارير والتحليلات</h2>
            <div class="flex items-center gap-2">
              <input type="file" id="csvUpload" accept=".csv" class="hidden" />
              <label for="csvUpload" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm cursor-pointer">تحميل CSV</label>
              <button id="btnExportRptPDF" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">تصدير PDF</button>
              <button id="btnExportRptXLSX" class="px-3 py-2 rounded-lg bg-slate-100 text-sm">تصدير Excel</button>
            </div>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
            <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">عدد المشاريع</div><div id="repProjects" class="text-2xl font-bold">—</div></div>
            <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">إجمالي التمويل</div><div id="repFunding" class="text-2xl font-bold">—</div></div>
            <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">الفعاليات المقبلة</div><div id="repEvents" class="text-2xl font-bold">—</div></div>
            <div class="bg-slate-50 rounded-xl p-4"><div class="text-xs text-slate-500">فرص التطوع</div><div id="repVol" class="text-2xl font-bold">—</div></div>
          </div>

          <div class="mt-4 overflow-auto scroll-slim">
            <table class="w-full text-sm" id="reportsTable">
              <thead>
                <tr class="text-right text-slate-500">
                  <th class="px-3 py-2">#</th>
                  <th class="px-3 py-2">المشروع</th>
                  <th class="px-3 py-2">القطاع</th>
                  <th class="px-3 py-2">المنطقة</th>
                  <th class="px-3 py-2">التمويل</th>
                  <th class="px-3 py-2">الحالة</th>
                </tr>
              </thead>
              <tbody id="reportsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- AI Lab -->
      <section id="ai" class="view hidden">
        <div class="bg-white rounded-2xl p-6 shadow-soft">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">مختبر الذكاء الاصطناعي</h2>
            <div class="text-xs text-slate-500">وضع تجريبي — دون اتصال بخادم خارجي</div>
          </div>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2 border rounded-2xl p-4 flex flex-col gap-3">
              <div id="aiFeed" class="prose-chat max-h-[420px] overflow-auto scroll-slim"></div>
              <div class="flex items-center gap-2">
                <input id="aiInput" class="rtl-input flex-1 border rounded-lg px-3 py-2" placeholder="اكتب سؤالك..."/>
                <button id="aiSend" class="px-3 py-2 rounded-lg bg-slate-900 text-white"><i data-lucide="send" class="w-4 h-4"></i></button>
              </div>
            </div>
            <div class="border rounded-2xl p-4 space-y-3">
              <div class="font-semibold">قوالب سريعة</div>
              <button class="w-full px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm" data-ai-template="اقترح مؤشرات أداء لمبادرة تمكين">مؤشرات أداء</button>
              <button class="w-full px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm" data-ai-template="صيّغ إعلان لفعالية تطوعية في حائل">نص إعلان</button>
              <button class="w-full px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm" data-ai-template="صمّم هيكل تقرير مختصر لمشاريع الجامعات">هيكل تقرير</button>
              <div class="text-xs text-slate-500">يمكن ربطه لاحقًا بـ API فعلي.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Integrations -->
      <section id="integrations" class="view hidden">
        <div class="bg-white rounded-2xl p-6 shadow-soft">
          <h2 class="text-lg font-semibold mb-2">التكاملات</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border rounded-2xl p-4">
              <div class="flex items-center justify-between">
                <div class="font-semibold">مفاتيح API</div>
                <button id="btnGenKey" class="px-3 py-2 rounded-lg bg-primary text-white text-sm">توليد مفتاح</button>
              </div>
              <div id="keysWrap" class="mt-3 space-y-2 text-sm"></div>
            </div>
            <div class="border rounded-2xl p-4">
              <div class="font-semibold">Webhooks</div>
              <form id="hookForm" class="mt-2 flex items-center gap-2">
                <input name="url" class="rtl-input flex-1 border rounded-lg px-3 py-2" placeholder="https://example.com/hook"/>
                <button class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">إضافة</button>
              </form>
              <div id="hooksWrap" class="mt-3 space-y-2 text-sm"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Admin Center -->
      <section id="admin-center" class="view hidden">
        <div class="bg-white rounded-2xl p-6 shadow-soft space-y-6">
          <div>
            <h3 class="text-lg font-semibold">إعدادات SSO</h3>
            <form id="ssoForm" class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
              <input name="issuer" class="rtl-input border rounded-lg px-3 py-2" placeholder="Issuer (OIDC/SAML)" />
              <input name="client_id" class="rtl-input border rounded-lg px-3 py-2" placeholder="Client ID" />
              <input name="client_secret" class="rtl-input border rounded-lg px-3 py-2" placeholder="Client Secret" />
              <input name="redirect" class="rtl-input border rounded-lg px-3 py-2 md:col-span-3" placeholder="Redirect URL" />
              <div class="md:col-span-3"><button class="px-3 py-2 rounded-lg bg-primary text-white text-sm">حفظ</button></div>
            </form>
          </div>

          <div>
            <h3 class="text-lg font-semibold">صلاحيات المستخدمين</h3>
            <div class="overflow-auto scroll-slim border rounded-2xl p-3">
              <table class="w-full text-sm">
                <thead><tr class="text-right text-slate-500">
                  <th class="px-3 py-2">المستخدم</th>
                  <th class="px-3 py-2">الدور</th>
                  <th class="px-3 py-2">عمليات</th>
                </tr></thead>
                <tbody id="usersTbody"></tbody>
              </table>
            </div>
            <form id="userAddForm" class="mt-3 flex items-center gap-2">
              <input name="name" class="rtl-input border rounded-lg px-3 py-2" placeholder="اسم المستخدم"/>
              <select name="role" class="rtl-input border rounded-lg px-2 py-2">
                <option value="viewer">Viewer</option>
                <option value="editor">Editor</option>
                <option value="manager">Manager</option>
                <option value="admin">Admin</option>
              </select>
              <button class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">إضافة</button>
            </form>

            <div class="mt-4">
              <div class="text-sm font-semibold mb-2">مصفوفة الأذونات</div>
              <div class="overflow-auto scroll-slim">
                <table class="w-full text-sm">
                  <thead><tr class="text-right text-slate-500">
                    <th class="px-3 py-2">الإجراء</th>
                    <th class="px-3 py-2">Viewer</th>
                    <th class="px-3 py-2">Editor</th>
                    <th class="px-3 py-2">Manager</th>
                    <th class="px-3 py-2">Admin</th>
                  </tr></thead>
                  <tbody>
                    <tr><td class="px-3 py-2">إنشاء مشروع</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✔️</td><td class="px-3 py-2">✔️</td><td class="px-3 py-2">✔️</td></tr>
                    <tr><td class="px-3 py-2">اعتماد فعالية</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✔️</td><td class="px-3 py-2">✔️</td></tr>
                    <tr><td class="px-3 py-2">إدارة المستخدمين</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✔️</td></tr>
                    <tr><td class="px-3 py-2">إنشاء منحة</td><td class="px-3 py-2">✖️</td><td class="px-3 py-2">✔️</td><td class="px-3 py-2">✔️</td><td class="px-3 py-2">✔️</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Per-account placeholders -->
      <section id="account-emirate" class="view hidden"></section>
      <section id="account-gov" class="view hidden"></section>
      <section id="account-private" class="view hidden"></section>
      <section id="account-nonprofit" class="view hidden"></section>
      <section id="account-uni" class="view hidden"></section>
      <section id="account-funder" class="view hidden"></section>
      <section id="account-people" class="view hidden"></section>
      <section id="account-speakers" class="view hidden"></section>
      <section id="account-admin" class="view hidden"></section>

    </main>
  </div>

  <!-- Footer -->
  <footer class="mt-6 py-6 border-t">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-wrap items-center justify-between gap-4">
      <div class="text-sm text-slate-500">© حصيف — جميع الحقوق محفوظة</div>
      <div class="flex items-center gap-3 opacity-70">
        <!-- تكرار الشعارات بشكل مصغر -->
        <svg class="h-6" viewBox="0 0 240 48" aria-hidden="true"><text x="0" y="34" font-size="28" font-family="Inter, system-ui" fill="#1f2937">VISION 2030</text></svg>
        <svg class="h-7" viewBox="0 0 240 60" aria-hidden="true"><text x="120" y="40" text-anchor="middle" font-size="28" font-family="Tajawal, system-ui" fill="#1f2937">مبادرة تلبية</text></svg>
      </div>
    </div>
  </footer>

  <!-- Drawer -->
  <div id="drawerDynamic" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/30" data-close-drawer></div>
    <div class="absolute left-0 top-0 bottom-0 w-full max-w-xl bg-white shadow-2xl p-6 overflow-y-auto">
      <div class="flex items-center justify-between sticky top-0 bg-white pb-3">
        <h3 id="drawerTitle" class="text-lg font-semibold">نموذج</h3>
        <button class="p-2 hover:bg-slate-100 rounded-lg" data-close-drawer><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <form id="drawerForm" class="space-y-4 mt-3"></form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 right-6 px-4 py-3 rounded-xl2 bg-emerald-600 text-white text-sm shadow-soft hidden">تم</div>

  <script>
    // ===== Helpers =====
    const $=(q,c=document)=>c.querySelector(q), $$=(q,c=document)=>Array.from(c.querySelectorAll(q));
    function toast(m){const el=$('#toast');el.textContent=m;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),1800);}

    // ===== RBAC =====
    const DB = { get:(k,f=[])=>JSON.parse(localStorage.getItem(k)||JSON.stringify(f)), set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };
    function setRole(role){ localStorage.setItem('me', JSON.stringify({role})); applyRoleUI(); }
    function getRole(){ return (JSON.parse(localStorage.getItem('me')||'{}').role) || 'viewer'; }
    function can(action){
      const role=getRole();
      const R = {
        'create_project':['editor','manager','admin'],
        'approve_event':['manager','admin'],
        'manage_users':['admin'],
        'create_grant':['editor','manager','admin'],
        'create_volunteer':['editor','manager','admin']
      };
      return (R[action]||[]).includes(role);
    }
    function applyRoleUI(){
      $('#btnNewProject').disabled = !can('create_project');
      $('#btnNewEvent').disabled = !can('create_project');
    }

    // ===== Seed data =====
    if (!DB.get('projects').length) DB.set('projects', [
      { id:1, name:'مختبر ابتكار اجتماعي', sector:'جامعات', region:'حائل', program:'جودة الحياة', fund:250000, status:'نشط' },
      { id:2, name:'تمكين الأسر المنتجة',  sector:'غير ربحي', region:'الرياض', program:'التحول الوطني', fund:180000, status:'قيد المراجعة' },
      { id:3, name:'مركز قيادة تطوعي',    sector:'حكومي', region:'مكة المكرمة', program:'تنمية القدرات البشرية', fund:320000, status:'نشط' }
    ]);
    if (!DB.get('events').length) DB.set('events', []);
    if (!DB.get('grants').length) DB.set('grants', []);
    if (!DB.get('volunteer').length) DB.set('volunteer', []);
    if (!DB.get('tickets').length) DB.set('tickets', []);
    if (!DB.get('keys').length) DB.set('keys', []);
    if (!DB.get('hooks').length) DB.set('hooks', []);
    if (!DB.get('users').length) DB.set('users', [
      {name:'مدير المنصة', role:'admin'},
      {name:'مسؤول مشاريع', role:'manager'},
      {name:'محرر', role:'editor'},
      {name:'قارئ', role:'viewer'}
    ]);
    if (!DB.get('sso')) DB.set('sso', {issuer:'',client_id:'',client_secret:'',redirect:''});

    // ===== Mock API =====
    const api = {
      async listProjects(filter={}){
        let r=DB.get('projects');
        if(filter.region) r=r.filter(x=>x.region===filter.region);
        if(filter.sector) r=r.filter(x=>x.sector===filter.sector);
        if(filter.program) r=r.filter(x=>x.program===filter.program);
        return r;
      },
      async createProject(p){ const rows=DB.get('projects'); const id=(rows.at(-1)?.id||0)+1; rows.push({id,status:'مسودة',...p}); DB.set('projects',rows); return {ok:true}; },
      async deleteProject(id){ DB.set('projects', DB.get('projects').filter(r=>r.id!==id)); return {ok:true}; },
      async listEvents(){ return DB.get('events'); }, async createEvent(p){ const rows=DB.get('events'); rows.push(p); DB.set('events',rows); return {ok:true}; },
      async listGrants(){ return DB.get('grants'); }, async createGrant(p){ const rows=DB.get('grants'); rows.push(p); DB.set('grants',rows); return {ok:true}; },
      async listVolunteer(){ return DB.get('volunteer'); }, async createVolunteer(p){ const rows=DB.get('volunteer'); rows.push(p); DB.set('volunteer',rows); return {ok:true}; }
    };

    // ===== Accounts & Modules =====
    const accounts=[
      { key:'emirate',  name_ar:'إمارة المنطقة', icon:'shield' },
      { key:'gov',      name_ar:'جهة حكومية',    icon:'building-2' },
      { key:'private',  name_ar:'قطاع خاص',      icon:'briefcase' },
      { key:'nonprofit',name_ar:'قطاع غير ربحي', icon:'heart' },
      { key:'uni',      name_ar:'الجامعات',      icon:'graduation-cap' },
      { key:'funder',   name_ar:'جهات مانحة',    icon:'wallet' },
      { key:'people',   name_ar:'الأفراد',       icon:'users' },
      { key:'speakers', name_ar:'مدربون/متحدثون',icon:'mic' },
      { key:'admin',    name_ar:'حوكمة المنصة',  icon:'settings' },
    ];
    function renderAccounts(){
      const wrap=$('#accountsGrid'); wrap.innerHTML='';
      accounts.forEach(a=>{
        const b=document.createElement('button');
        b.className='flex items-center gap-2 px-3 py-2 rounded-lg border hover:bg-slate-50 text-sm';
        b.innerHTML = `<i data-lucide="${a.icon}" class="w-4 h-4"></i><span>${a.name_ar}</span>`;
        b.onclick=()=>{ switchView('account-'+a.key); };
        wrap.appendChild(b);
      });
      lucide.createIcons();
    }
    function renderModules(){
      const wrap=$('#modulesGrid'); wrap.innerHTML='';
      const M={projects:'مشاريع',events:'فعاليات',jobs:'وظائف/تطوع',funding:'تمويل/منح',reports:'تقارير'};
      const I={projects:'folder-kanban',events:'calendar',jobs:'badge-check',funding:'credit-card',reports:'bar-chart-3'};
      Object.keys(M).forEach(k=>{
        const b=document.createElement('button');
        b.className='flex items-center gap-2 px-3 py-2 rounded-lg border hover:bg-slate-50 text-sm';
        b.innerHTML=`<i data-lucide="${I[k]}" class="w-4 h-4"></i><span>${M[k]}</span>`;
        b.onclick=()=>{ if(k==='projects') switchView('dashboard'); else if(k==='events') switchView('map'); else if(k==='reports') switchView('reports'); else toast('المكوّن: '+M[k]); };
        wrap.appendChild(b);
      });
      lucide.createIcons();
    }

    // ===== KPIs + Projects table =====
    async function renderKPIs(){
      const rows=await api.listProjects({});
      $('#kpiProjects').textContent=rows.length;
      $('#kpiFunding').textContent=rows.reduce((s,p)=>s+(+p.fund||0),0).toLocaleString('ar-EG');
      $('#kpiEvents').textContent=(await api.listEvents()).length;
      $('#kpiVol').textContent=(await api.listVolunteer()).length;
    }
    async function renderProjectsTable(){
      const region=$('#filterRegion').value; const sector=$('#filterSector').value; const program=$('#filterProgram').value;
      const q=$('#globalSearch').value.trim();
      let list=await api.listProjects({region,sector,program});
      if(q){ const terms=q.split(/\s+/); list=list.filter(p=> terms.every(t=> (p.name+p.sector+p.region+p.program+p.status).includes(t))); }
      const tb=$('#projectsTbody'); tb.innerHTML='';
      list.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td class='px-3 py-3 font-medium'>${p.name}</td>
                        <td class='px-3 py-3 text-slate-600'>${p.sector||'-'}</td>
                        <td class='px-3 py-3 text-slate-600'>${p.region||'-'}</td>
                        <td class='px-3 py-3 text-slate-600'>${p.program||'-'}</td>
                        <td class='px-3 py-3 text-slate-600'>${(+p.fund||0).toLocaleString('ar-EG')}</td>
                        <td class='px-3 py-3'><span class='tag ${p.status==='نشط'?'bg-emerald-100 text-emerald-700':p.status==='قيد المراجعة'?'bg-amber-100 text-amber-700':'bg-slate-100 text-slate-700'}'>${p.status||'-'}</span></td>
                        <td class='px-3 py-3'><button class='p-2 rounded-lg hover:bg-slate-100' ${!can('create_project')?'disabled':''} data-del='${p.name}'><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button[data-del]').forEach(b=> b.onclick=async()=>{
        if(!can('create_project')) return;
        const name=b.dataset.del;
        DB.set('projects', DB.get('projects').filter(x=>x.name!==name));
        renderProjectsTable(); renderKPIs();
      });
      lucide.createIcons();
    }

    // ===== Map =====
    let mapInstance=null;
    function initMap(){
      if(mapInstance){ mapInstance.invalidateSize(); return; }
      mapInstance=L.map('leafletMap').setView([23.8859,45.0792],5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap contributors'}).addTo(mapInstance);
      [
        { name:'حائل', lat:27.52, lng:41.69, count:12 },
        { name:'الرياض', lat:24.71, lng:46.67, count:18 },
        { name:'مكة', lat:21.39, lng:39.85, count:9 }
      ].forEach(r=> L.marker([r.lat,r.lng]).addTo(mapInstance).bindPopup(`<div class="text-sm"><b>${r.name}</b><br>مشاريع: ${r.count}</div>`));
    }

    // ===== Reports =====
    async function renderReports(){
      const rows=await api.listProjects({});
      $('#repProjects').textContent=rows.length;
      $('#repFunding').textContent=rows.reduce((s,p)=>s+(+p.fund||0),0).toLocaleString('ar-EG');
      $('#repEvents').textContent=(await api.listEvents()).length;
      $('#repVol').textContent=(await api.listVolunteer()).length;
      const tb=$('#reportsTbody'); tb.innerHTML='';
      rows.forEach((p,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td class='px-3 py-3 text-slate-500'>${i+1}</td>
                        <td class='px-3 py-3 font-medium'>${p.name}</td>
                        <td class='px-3 py-3 text-slate-600'>${p.sector||'-'}</td>
                        <td class='px-3 py-3 text-slate-600'>${p.region||'-'}</td>
                        <td class='px-3 py-3 text-slate-600'>${(+p.fund||0).toLocaleString('ar-EG')}</td>
                        <td class='px-3 py-3'><span class='tag ${p.status==='نشط'?'bg-emerald-100 text-emerald-700':p.status==='قيد المراجعة'?'bg-amber-100 text-amber-700':'bg-slate-100 text-slate-700'}'>${p.status||'-'}</span></td>`;
        tb.appendChild(tr);
      });
    }
    document.addEventListener('click',(e)=>{
      if(e.target && e.target.id==='btnExportRptPDF'){
        const {jsPDF}=window.jspdf;
        const doc=new jsPDF();
        doc.setFontSize(14); doc.text('تقرير المشاريع',14,16);
        const head=[['#','المشروع','القطاع','المنطقة','التمويل','الحالة']];
        const body=Array.from(document.querySelectorAll('#reportsTbody tr')).map(tr=>Array.from(tr.querySelectorAll('td')).map(td=>td.innerText.trim()));
        doc.autoTable({head,body,startY:22,styles:{fontSize:10}}); doc.save('report.pdf');
      }
    });
    document.getElementById('btnExportRptXLSX').onclick=async()=>{
      const rows=await api.listProjects({});
      const data=[['#','Project','Sector','Region','Funding','Status']];
      rows.forEach((p,i)=> data.push([i+1,p.name,p.sector,p.region,p.fund,p.status]));
      const ws=XLSX.utils.aoa_to_sheet(data); const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Report'); XLSX.writeFile(wb,'report.xlsx');
    };
    document.getElementById('csvUpload').addEventListener('change', async (e)=>{
      const f=e.target.files[0]; if(!f) return; const text=await f.text();
      const rows=text.split(/\r?\n/).slice(1).filter(Boolean).map(l=>l.split(','));
      const list=DB.get('projects');
      rows.forEach(r=>{
        if(r.length>=6) list.push({ name:r[0], sector:r[1], region:r[2], program:r[3], fund:+r[4]||0, status:r[5]||'مسودة' });
      });
      DB.set('projects',list); toast('تم تحميل CSV'); renderReports(); renderProjectsTable(); renderKPIs(); e.target.value='';
    });

    // ===== Support: tickets =====
    document.addEventListener('submit', async (e)=>{
      if(e.target && e.target.id==='formTicket'){
        e.preventDefault();
        const fd=new FormData(e.target);
        const rows=DB.get('tickets'); const id=(rows.at(-1)?.id||0)+1;
        rows.push({id,status:'مفتوحة',created_at:new Date().toISOString(),...Object.fromEntries(fd.entries())});
        DB.set('tickets', rows);
        e.target.reset(); toast('تم فتح التذكرة'); renderTickets();
      }
    });
    async function renderTickets(){
      const list=await DB.get('tickets'); const wrap=$('#ticketsWrap'); if(!wrap) return;
      wrap.innerHTML='';
      list.slice(-5).reverse().forEach(t=>{
        const div=document.createElement('div');
        div.className='p-3 rounded-xl bg-slate-50';
        div.innerHTML=`<div class='text-xs text-slate-500'>${t.created_at.slice(0,10)} • ${t.topic}</div><div class='font-medium mt-1'>${t.name} — ${t.email}</div><div class='text-sm text-slate-600 mt-1 line-clamp-2'>${t.message}</div>`;
        wrap.appendChild(div);
      });
    }

    // ===== Drawer (dynamic) =====
    function openDrawer(title, fields, onSubmit){
      $('#drawerTitle').textContent = title;
      const form=$('#drawerForm'); form.innerHTML='';
      fields.forEach(f=>{
        const wrap=document.createElement('div');
        if(f.type==='textarea') wrap.innerHTML = `<label class='text-sm block mb-1'>${f.label}</label><textarea name='${f.name}' rows='${f.rows||3}' class='rtl-input w-full border rounded-lg px-3 py-2' ${f.required?'required':''}></textarea>`;
        else if(f.type==='select') wrap.innerHTML = `<label class='text-sm block mb-1'>${f.label}</label><select name='${f.name}' class='rtl-input w-full border rounded-lg px-3 py-2'>${(f.options||[]).map(o=>`<option>${o}</option>`).join('')} </select>`;
        else wrap.innerHTML = `<label class='text-sm block mb-1'>${f.label}</label><input name='${f.name}' type='${f.type||"text"}' class='rtl-input w-full border rounded-lg px-3 py-2' ${f.min?`min='${f.min}'`:''} ${f.max?`max='${f.max}'`:''} ${f.step?`step='${f.step}'`:''} ${f.required?'required':''} placeholder='${f.placeholder||""}' />`;
        form.appendChild(wrap);
      });
      const actions=document.createElement('div'); actions.className='pt-2 flex items-center gap-2';
      actions.innerHTML = `<button class='px-4 py-2 rounded-lg bg-primary text-white'>حفظ</button><button type='button' class='px-4 py-2 rounded-lg bg-slate-100' data-close-drawer>إلغاء</button>`;
      form.appendChild(actions);
      form.onsubmit = async (e)=>{ e.preventDefault(); const fd=new FormData(form); await onSubmit(Object.fromEntries(fd.entries())); closeDrawer(); toast('تم الحفظ'); };
      $('#drawerDynamic').classList.remove('hidden');
      $$('#drawerDynamic [data-close-drawer]').forEach(b=> b.onclick=closeDrawer);
      lucide.createIcons();
    }
    function closeDrawer(){ $('#drawerDynamic').classList.add('hidden'); }

    // ===== AI Lab logic (offline demo) =====
    let aiInit=false;
    function initAIOnce(){
      if(aiInit) return; aiInit=true;
      const feed=$('#aiFeed');
      function push(role,txt){ const p=document.createElement('p'); p.innerHTML=`<span class='font-semibold'>${role==='user'?'أنت':'حصيف'}</span>: ${txt}`; feed.appendChild(p); feed.scrollTop=feed.scrollHeight; }
      function reply(q){
        const t=q.toLowerCase();
        if(q.includes('مؤشر')||t.includes('kpi')) return 'أمثلة: عدد المستفيدين، تكلفة لكل مستفيد، نسبة التوظيف بعد البرنامج، درجة الرضا، الاستدامة (12 شهرًا).';
        if(q.includes('هيكل')||q.includes('تقرير')) return 'هيكل مقترح: ملخص تنفيذي، المنهجية، البيانات، التحليل، الأثر، التوصيات، الملاحق.';
        if(q.includes('إعلان')||q.includes('فعالية')) return 'نص مختصر: ندعوكم لفعالية تطوعية في حائل يوم الجمعة 7:00م، للتسجيل عبر المنصة — الأماكن محدودة.';
        return 'تم — هذه إجابة افتراضية. يمكن ربط المختبر لاحقًا بمحرك ذكاء اصطناعي فعلي.';
      }
      $('#aiSend').onclick=()=>{ const q=$('#aiInput').value.trim(); if(!q) return; push('user',q); $('#aiInput').value=''; setTimeout(()=> push('assistant', reply(q)), 300); };
      $$('[data-ai-template]').forEach(b=> b.onclick=()=>{ $('#aiInput').value=b.getAttribute('data-ai-template'); $('#aiSend').click(); });
    }

    // ===== Integrations =====
    function renderIntegrations(){
      const keys=DB.get('keys'); const wrap=$('#keysWrap'); wrap.innerHTML='';
      keys.forEach((k,i)=>{
        const row=document.createElement('div');
        row.className='flex items-center justify-between bg-slate-50 rounded-lg px-3 py-2';
        row.innerHTML=`<code class='text-xs break-all'>${k}</code><button class='px-2 py-1 rounded bg-slate-100 text-xs' data-del-key='${i}'>حذف</button>`;
        wrap.appendChild(row);
      });
      wrap.querySelectorAll('[data-del-key]').forEach(btn=> btn.onclick=()=>{
        const idx=+btn.dataset.delKey; const arr=DB.get('keys'); arr.splice(idx,1); DB.set('keys',arr); renderIntegrations();
      });
      const hooks=DB.get('hooks'); const hw=$('#hooksWrap'); hw.innerHTML='';
      hooks.forEach((u,i)=>{
        const row=document.createElement('div');
        row.className='flex items-center justify-between bg-slate-50 rounded-lg px-3 py-2';
        row.innerHTML=`<span class='text-xs'>${u}</span><button class='px-2 py-1 rounded bg-slate-100 text-xs' data-del-hook='${i}'>حذف</button>`;
        hw.appendChild(row);
      });
      hw.querySelectorAll('[data-del-hook]').forEach(b=> b.onclick=()=>{
        const idx=+b.dataset.delHook; const arr=DB.get('hooks'); arr.splice(idx,1); DB.set('hooks',arr); renderIntegrations();
      });
    }
    document.addEventListener('click',(e)=>{
      if(e.target && e.target.id==='btnGenKey'){
        const token=Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);
        const arr=DB.get('keys'); arr.push('hasseef_'+token); DB.set('keys',arr); renderIntegrations();
      }
    });
    document.getElementById('hookForm')?.addEventListener('submit',(e)=>{
      if(e.target && e.target.id==='hookForm'){ e.preventDefault();
        const url=new FormData(e.target).get('url').trim(); if(!url) return;
        const arr=DB.get('hooks'); arr.push(url); DB.set('hooks',arr); e.target.reset(); renderIntegrations();
      }
    });

    // ===== Admin center — users & SSO =====
    function renderUsers(){
      const tb=$('#usersTbody'); if(!tb) return; tb.innerHTML='';
      DB.get('users').forEach((u,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class='px-3 py-2 font-medium'>${u.name}</td>
                      <td class='px-3 py-2'>${u.role}</td>
                      <td class='px-3 py-2'>
                        <button class='px-2 py-1 rounded bg-slate-100 text-xs' data-promote='${i}'>ترقية</button>
                        <button class='px-2 py-1 rounded bg-slate-100 text-xs' data-demote='${i}'>تخفيض</button>
                        <button class='px-2 py-1 rounded bg-slate-100 text-xs' data-del='${i}'>حذف</button>
                      </td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{
        const arr=DB.get('users'); arr.splice(+b.dataset.del,1); DB.set('users',arr); renderUsers();
      });
      const order=['viewer','editor','manager','admin'];
      tb.querySelectorAll('[data-promote]').forEach(b=> b.onclick=()=>{
        const arr=DB.get('users'); const u=arr[+b.dataset.promote]; const idx=order.indexOf(u.role);
        u.role=order[Math.min(order.length-1, idx+1)]; DB.set('users',arr); renderUsers();
      });
      tb.querySelectorAll('[data-demote]').forEach(b=> b.onclick=()=>{
        const arr=DB.get('users'); const u=arr[+b.dataset.demote]; const idx=order.indexOf(u.role);
        u.role=order[Math.max(0, idx-1)]; DB.set('users',arr); renderUsers();
      });
    }
    document.getElementById('userAddForm')?.addEventListener('submit',(e)=>{
      if(e.target && e.target.id==='userAddForm'){ e.preventDefault();
        const fd=new FormData(e.target); const arr=DB.get('users');
        arr.push({name:fd.get('name')||'مستخدم', role:fd.get('role')}); DB.set('users',arr); e.target.reset(); renderUsers();
      }
    });
    function loadSSO(){
      const s=DB.get('sso'); const f=$('#ssoForm'); if(!f) return;
      f.issuer.value=s.issuer||''; f.client_id.value=s.client_id||''; f.client_secret.value=s.client_secret||''; f.redirect.value=s.redirect||'';
    }
    document.getElementById('ssoForm')?.addEventListener('submit',(e)=>{
      if(e.target && e.target.id==='ssoForm'){ e.preventDefault();
        const fd=new FormData(e.target);
        const conf={ issuer:fd.get('issuer'), client_id:fd.get('client_id'), client_secret:fd.get('client_secret'), redirect:fd.get('redirect') };
        DB.set('sso',conf); toast('تم حفظ إعدادات SSO');
      }
    });

    // ===== Routing =====
    function switchView(id){
      $$('.view').forEach(v=> v.classList.add('hidden'));
      const view=$('#'+id); if(view) view.classList.remove('hidden');
      $$('#navMain .navlink').forEach(b=> b.classList.remove('bg-slate-100'));
      $(`#navMain .navlink[data-route="${id}"]`)?.classList.add('bg-slate-100');
      location.hash=id;
      if(id==='map') setTimeout(()=>{ initMap(); mapInstance && mapInstance.invalidateSize(); }, 60);
      if(id==='reports') renderReports();
      if(id==='support') renderTickets();
      if(id==='integrations') renderIntegrations();
      if(id==='admin-center'){ renderUsers(); loadSSO(); }
      if(id==='ai') initAIOnce();
    }
    window.addEventListener('hashchange', ()=> switchView(location.hash.replace('#','') || 'dashboard'));
    window.addEventListener('keydown', (e)=>{ if(e.altKey && e.key==='1') switchView('dashboard'); });

    // ===== Language & Role =====
    document.getElementById('btnAR').onclick = ()=>{ document.documentElement.lang='ar'; document.documentElement.dir='rtl'; toast('تم التبديل للعربية'); };
    document.getElementById('btnEN').onclick = ()=>{ document.documentElement.lang='en'; document.documentElement.dir='ltr'; toast('Switched to English'); };
    const roleSel = document.getElementById('roleSelect'); roleSel.value = getRole(); roleSel.onchange = ()=> setRole(roleSel.value);

    // ===== Filters + search =====
    $('#filterRegion').onchange = renderProjectsTable;
    $('#filterSector').onchange = renderProjectsTable;
    $('#filterProgram').onchange = renderProjectsTable;
    $('#btnResetFilters').onclick = ()=>{ $('#filterRegion').value=''; $('#filterSector').value=''; $('#filterProgram').value=''; $('#globalSearch').value=''; renderProjectsTable(); };
    $('#globalSearch').addEventListener('input', renderProjectsTable);

    // ===== Quick create =====
    document.getElementById('btnNewProject').onclick = ()=>{
      if(!can('create_project')) return toast('ليس لديك صلاحية الإنشاء');
      openDrawer('مشروع جديد', [
        {name:'name',label:'اسم المشروع',required:true},
        {name:'sector',label:'القطاع',type:'select',options:['حكومي','خاص','غير ربحي','جامعات']},
        {name:'region',label:'المنطقة',type:'select',options:['حائل','الرياض','مكة المكرمة']},
        {name:'program',label:'برنامج الرؤية',type:'select',options:['جودة الحياة','التحول الوطني','تنمية القدرات البشرية','تطوير القطاع المالي','الصناعة الوطنية والخدمات اللوجستية','الإسكان']},
        {name:'fund',label:'قيمة التمويل (ر.س)',type:'number',min:0,step:1000},
        {name:'status',label:'الحالة',type:'select',options:['مسودة','قيد المراجعة','نشط']}
      ], async (p)=>{ await api.createProject(p); renderProjectsTable(); renderKPIs(); });
    };
    document.getElementById('btnNewEvent').onclick = ()=>{
      openDrawer('فعالية جديدة', [
        {name:'title',label:'عنوان الفعالية',required:true},
        {name:'date',label:'التاريخ',type:'date',required:true},
        {name:'venue',label:'الموقع/المرفق'}
      ], async (p)=>{ await api.createEvent(p); renderKPIs(); });
    };

    // ===== Init =====
    function init(){
      renderAccounts(); renderModules(); renderKPIs(); renderProjectsTable();
      switchView(location.hash.replace('#','') || 'dashboard');
      lucide.createIcons(); applyRoleUI();
    }
    init();
  </script>
</body>
</html>
